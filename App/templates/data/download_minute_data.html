{% extends "base.html" %}
{% block content %}
<div class="download-container">
    <div class="download-card">
        <div class="download-header">
            <h2>æ‰¹é‡ä¸‹è½½1åˆ†é’Ÿæ•°æ®</h2>
        </div>
        
        <div class="download-content">
            <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
            <div class="button-group">
                <button id="startBtn" class="btn btn-primary">
                    å¼€å§‹ä¸‹è½½
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    æš‚åœä¸‹è½½
                </button>
                <button id="resampleBtn" class="btn btn-success">
                    é‡æ–°é‡‡æ ·ä¸ºæ—¥çº¿æ•°æ®
                </button>
                <button id="openFolderBtn" class="btn btn-info">
                    æ‰“å¼€æ•°æ®æ–‡ä»¶å¤¹
                </button>
            </div>
            
            <!-- ç»Ÿè®¡æ•°æ®åŒºåŸŸ -->
            <div class="stats-section">
                <h3>ä¸‹è½½ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number stat-total" id="totalCount">-</div>
                        <div class="stat-label">æ€»è‚¡ç¥¨æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number stat-pending" id="pendingCount">-</div>
                        <div class="stat-label">ç­‰å¾…ä¸‹è½½</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number stat-success" id="successCount">-</div>
                        <div class="stat-label">ä¸‹è½½æˆåŠŸ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number stat-failed" id="failedCount">-</div>
                        <div class="stat-label">ä¸‹è½½å¤±è´¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number stat-processing" id="processingCount">-</div>
                        <div class="stat-label">æ­£åœ¨ä¸‹è½½</div>
                    </div>
                </div>
            </div>
            
            <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="progress-section">
                <h3>ä¸‹è½½è¿›åº¦</h3>
                <div class="progress-info">
                    <div class="progress-item">
                        <strong>ä»»åŠ¡çŠ¶æ€ï¼š</strong>
                        <span id="statusText">æœªå¼€å§‹</span>
                    </div>
                    <div class="progress-item">
                        <strong>è¿›åº¦ï¼š</strong>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress-item">
                        <strong>å½“å‰è‚¡ç¥¨ï¼š</strong>
                        <span id="currentStock">-</span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar-fill"></div>
                </div>
            </div>
            
            <!-- ä¸‹è½½è¯¦æƒ…åŒºåŸŸ -->
            <div class="details-section">
                <h3>ä¸‹è½½è¯¦æƒ…</h3>
                <div class="details-tabs">
                    <button class="tab-button active" onclick="showTab('success')">æˆåŠŸåˆ—è¡¨</button>
                    <button class="tab-button" onclick="showTab('failed')">å¤±è´¥åˆ—è¡¨</button>
                    <button class="tab-button" onclick="showTab('logs')">å®æ—¶æ—¥å¿—</button>
                </div>
                
                <div id="successTab" class="tab-content active">
                    <div class="stock-list" id="successList">
                        <div class="empty-message">æš‚æ— æˆåŠŸä¸‹è½½çš„è‚¡ç¥¨</div>
                    </div>
                </div>
                
                <div id="failedTab" class="tab-content">
                    <div class="stock-list" id="failedList">
                        <div class="empty-message">æš‚æ— ä¸‹è½½å¤±è´¥çš„è‚¡ç¥¨</div>
                    </div>
                </div>
                
                <div id="logsTab" class="tab-content">
                    <div class="log-container" id="logContainer">
                        <div class="empty-message">æš‚æ— æ—¥å¿—ä¿¡æ¯</div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®ä¿å­˜ä¿¡æ¯ -->
            <div class="info-section">
                <h3>æ•°æ®ä¿å­˜ä¿¡æ¯</h3>
                <div class="info-content">
                    <div class="info-item">
                        <strong>ä¿å­˜ä½ç½®ï¼š</strong>
                        <span>æœ¬åœ°CSVæ–‡ä»¶</span>
                    </div>
                    <div class="info-item">
                        <strong>æ–‡ä»¶æ ¼å¼ï¼š</strong>
                        <span>æŒ‰å­£åº¦ä¿å­˜ï¼Œè‚¡ç¥¨ä»£ç .csv</span>
                    </div>
                    <div class="info-item">
                        <strong>ä¿å­˜è·¯å¾„ï¼š</strong>
                        <span>data/data/quarters/å¹´ä»½/å­£åº¦/</span>
                    </div>
                    <div class="info-item">
                        <strong>æ•°æ®æ¥æºï¼š</strong>
                        <span>ä¸œæ–¹è´¢å¯Œç½‘</span>
                    </div>
                    <div class="info-item">
                        <strong>æ•°æ®é¢‘ç‡ï¼š</strong>
                        <span>1åˆ†é’Ÿ</span>
                    </div>
                </div>
            </div>
            
            <!-- å½“å‰çŠ¶æ€ -->
            <div class="warning-section">
                <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
                <div class="warning-content">
                    <div class="warning-item">
                        <strong>ç½‘ç»œçŠ¶æ€ï¼š</strong>
                        <span id="networkStatus">æ£€æµ‹ä¸­...</span>
                    </div>
                    <div class="warning-item">
                        <strong>æ•°æ®æºï¼š</strong>
                        <span id="dataSourceStatus">ä¸œæ–¹è´¢å¯Œç½‘ï¼ˆæ£€æµ‹ä¸­...ï¼‰</span>
                    </div>
                    <div class="warning-item">
                        <strong>ä¸‹è½½çŠ¶æ€ï¼š</strong>
                        <span id="downloadStatusText">å‡†å¤‡å°±ç»ª</span>
                    </div>
                    <div class="warning-item">
                        <strong>è¯´æ˜ï¼š</strong>
                        <span>ç³»ç»Ÿå·²ä¼˜åŒ–ï¼Œæ”¯æŒBrotliå‹ç¼©æ•°æ®è§£æ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.download-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
}

.download-card {
    background-color: var(--card-background);
    border-radius: 1rem;
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.download-header {
    background-color: var(--primary-color);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.download-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.download-content {
    padding: 2rem;
}

.button-group {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: var(--secondary-color);
}

.btn-danger {
    background-color: #dc2626;
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background-color: #b91c1c;
}

.btn-info {
    background-color: #0891b2;
    color: white;
}

.btn-info:hover:not(:disabled) {
    background-color: #0e7490;
}

.stats-section {
    margin-bottom: 2rem;
}

.stats-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    background-color: var(--background-color);
    padding: 1.5rem;
    border-radius: 0.75rem;
}

.stat-item {
    text-align: center;
    padding: 1rem 0.5rem;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.stat-total { color: var(--primary-color); }
.stat-pending { color: var(--warning-color); }
.stat-success { color: var(--success-color); }
.stat-failed { color: #dc2626; }
.stat-processing { color: #0891b2; }

.progress-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

.progress-info {
    margin-bottom: 1rem;
}

.progress-item {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.progress-item strong {
    color: var(--text-secondary);
}

.progress-bar-container {
    width: 100%;
    height: 1.5rem;
    background-color: var(--background-color);
    border-radius: 0.75rem;
    overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    border-radius: 0.75rem;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    min-width: 2rem;
}

.info-section {
    background-color: var(--background-color);
    padding: 1.5rem;
    border-radius: 0.75rem;
}

.info-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

.info-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.info-item {
    color: var(--text-primary);
    font-size: 0.875rem;
}

.info-item strong {
    color: var(--text-secondary);
    margin-right: 0.5rem;
}

.warning-section {
    background-color: #fef3cd;
    border: 1px solid #fecba1;
    padding: 1.5rem;
    border-radius: 0.75rem;
    margin-top: 1rem;
}

.warning-section h3 {
    margin-bottom: 1rem;
    color: #856404;
    font-size: 1.25rem;
    font-weight: 600;
}

.warning-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.warning-item {
    color: #856404;
    font-size: 0.875rem;
}

.warning-item strong {
    color: #856404;
    margin-right: 0.5rem;
}

.details-section {
    margin-bottom: 2rem;
}

.details-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
}

.details-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--background-color);
}

.tab-button {
    padding: 0.75rem 1.5rem;
    border: none;
    background-color: transparent;
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.tab-button.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-button:hover:not(.active) {
    color: var(--text-primary);
}

.tab-content {
    display: none;
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
}

.tab-content.active {
    display: block;
}

.stock-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.stock-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background-color: var(--background-color);
    border-radius: 0.5rem;
    border-left: 4px solid var(--success-color);
}

.stock-item.failed {
    border-left-color: #dc2626;
}

.stock-code {
    font-weight: 600;
    color: var(--text-primary);
}

.stock-status {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.stock-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.log-container {
    background-color: #1a1a1a;
    color: #00ff00;
    padding: 1rem;
    border-radius: 0.5rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.4;
    max-height: 300px;
    overflow-y: auto;
}

.log-entry {
    margin-bottom: 0.25rem;
}

.log-entry.success {
    color: #00ff00;
}

.log-entry.error {
    color: #ff4444;
}

.log-entry.warning {
    color: #ffaa00;
}

.log-entry.info {
    color: #00aaff;
}

.empty-message {
    text-align: center;
    color: var(--text-secondary);
    font-style: italic;
    padding: 2rem;
}

@media (max-width: 768px) {
    .download-content {
        padding: 1rem;
    }
    
    .button-group {
        flex-direction: column;
        align-items: center;
    }
    
    .btn {
        width: 100%;
        max-width: 200px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .info-content {
        font-size: 0.8rem;
    }
}
</style>
<script>
let polling = null;
let statsPolling = null;
let detailsPolling = null;
let networkPolling = null;
let dataSourcePolling = null;
let statusDisplayPolling = null;
let successStocks = [];
let failedStocks = [];
let downloadLogs = [];
let lastDownloadStatus = {status: 'æœªå¼€å§‹', progress: 0}; // ç¼“å­˜æœ€åçš„ä¸‹è½½çŠ¶æ€

// æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
function showTab(tabName) {
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
    event.target.classList.add('active');
}

// æ›´æ–°æˆåŠŸè‚¡ç¥¨åˆ—è¡¨
function updateSuccessList() {
    const container = document.getElementById('successList');
    if (successStocks.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— æˆåŠŸä¸‹è½½çš„è‚¡ç¥¨</div>';
        return;
    }
    
    container.innerHTML = successStocks.map(stock => `
        <div class="stock-item">
            <div>
                <div class="stock-code">${stock.code}</div>
                <div class="stock-status">${stock.records} æ¡è®°å½•</div>
            </div>
            <div class="stock-time">${stock.time}</div>
        </div>
    `).join('');
}

// æ›´æ–°å¤±è´¥è‚¡ç¥¨åˆ—è¡¨
function updateFailedList() {
    const container = document.getElementById('failedList');
    if (failedStocks.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— ä¸‹è½½å¤±è´¥çš„è‚¡ç¥¨</div>';
        return;
    }
    
    container.innerHTML = failedStocks.map(stock => `
        <div class="stock-item failed">
            <div>
                <div class="stock-code">${stock.code}</div>
                <div class="stock-status">${stock.error}</div>
            </div>
            <div class="stock-time">${stock.time}</div>
        </div>
    `).join('');
}

// æ›´æ–°æ—¥å¿—æ˜¾ç¤º
function updateLogs() {
    const container = document.getElementById('logContainer');
    if (downloadLogs.length === 0) {
        container.innerHTML = '<div class="empty-message">æš‚æ— æ—¥å¿—ä¿¡æ¯</div>';
        return;
    }
    
    container.innerHTML = downloadLogs.map(log => `
        <div class="log-entry ${log.type}">[${log.time}] ${log.message}</div>
    `).join('');
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    container.scrollTop = container.scrollHeight;
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    downloadLogs.push({
        time: timeStr,
        message: message,
        type: type
    });
    
    // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—
    if (downloadLogs.length > 100) {
        downloadLogs.shift();
    }
    
    updateLogs();
}

function updateStatistics() {
    console.log('[DEBUG] å¼€å§‹æ›´æ–°ç»Ÿè®¡æ•°æ®...');
    fetch('{{ url_for("download_data_bp.get_download_statistics") }}')
        .then(res => {
            console.log('[DEBUG] å“åº”çŠ¶æ€:', res.status);
            return res.json();
        })
        .then(data => {
            console.log('[DEBUG] è·å–åˆ°ç»Ÿè®¡æ•°æ®:', data);
            document.getElementById('totalCount').innerText = data.total || 0;
            document.getElementById('pendingCount').innerText = data.pending || 0;
            document.getElementById('successCount').innerText = data.success || 0;
            document.getElementById('failedCount').innerText = data.failed || 0;
            document.getElementById('processingCount').innerText = data.processing || 0;
            console.log('[DEBUG] ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ');
        })
        .catch(error => {
            console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        });
}

// æ›´æ–°è¯¦ç»†ä¸‹è½½ä¿¡æ¯
function updateDownloadDetails() {
    fetch('{{ url_for("download_data_bp.get_download_details") }}')
        .then(res => res.json())
        .then(data => {
            // æ›´æ–°æˆåŠŸåˆ—è¡¨
            if (data.success && data.success.length > 0) {
                successStocks = data.success;
                updateSuccessList();
            }
            
            // æ›´æ–°å¤±è´¥åˆ—è¡¨
            if (data.failed && data.failed.length > 0) {
                failedStocks = data.failed;
                updateFailedList();
            }
        })
        .catch(error => {
            console.error('è·å–ä¸‹è½½è¯¦æƒ…å¤±è´¥:', error);
        });
}

function updateStatus() {
    console.log('[DEBUG] updateStatus() è¢«è°ƒç”¨');
    fetch('{{ url_for("download_data_bp.get_download_status") }}')
        .then(res => res.json())
        .then(data => {
            // æ›´æ–°ç¼“å­˜çš„çŠ¶æ€
            lastDownloadStatus = {status: data.status, progress: data.progress};
            
            document.getElementById('statusText').innerText = data.status;
            document.getElementById('progressText').innerText = data.progress + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = data.progress + '%';
            progressBar.innerText = data.progress + '%';
            
            // åŒæ—¶æ›´æ–°ä¸‹è½½çŠ¶æ€æ˜¾ç¤ºï¼ˆé¿å…é‡å¤è°ƒç”¨APIï¼‰
            updateDownloadStatusDisplayFromCache();
            
            if (data.status === 'å·²å®Œæˆ' || data.status === 'å·²åœæ­¢' || data.status === 'æ— æ•°æ®ä¸‹è½½') {
                console.log('[DEBUG] ä¸‹è½½å·²å®Œæˆ/åœæ­¢ï¼Œæ¸…ç†pollingå®šæ—¶å™¨');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                if (polling) {
                    clearInterval(polling);
                    polling = null;
                    console.log('[DEBUG] pollingå®šæ—¶å™¨å·²æ¸…ç†');
                }
            }
        })
        .catch(error => {
            console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
        });
}

// æ£€æµ‹ç½‘ç»œçŠ¶æ€
function checkNetworkStatus() {
    const statusElement = document.getElementById('networkStatus');
    
    // ä½¿ç”¨è½»é‡çº§çš„ç»Ÿè®¡APIæ¥æ£€æµ‹ç½‘ç»œ
    fetch('{{ url_for("download_data_bp.get_download_statistics") }}')
        .then(response => {
            if (response.ok) {
                statusElement.textContent = 'æœ¬åœ°æœåŠ¡å™¨è¿æ¥æ­£å¸¸';
                statusElement.style.color = '#10b981';
            } else {
                statusElement.textContent = 'æœ¬åœ°æœåŠ¡å™¨è¿æ¥å¼‚å¸¸';
                statusElement.style.color = '#dc2626';
            }
        })
        .catch(error => {
            statusElement.textContent = 'ç½‘ç»œè¿æ¥å¤±è´¥';
            statusElement.style.color = '#dc2626';
        });
}

// æ£€æµ‹æ•°æ®æºçŠ¶æ€
function checkDataSourceStatus() {
    const statusElement = document.getElementById('dataSourceStatus');
    
    // å°è¯•è®¿é—®ä¸œæ–¹è´¢å¯ŒAPIæ¥æ£€æµ‹æ•°æ®æºçŠ¶æ€
    const testUrl = 'https://push2his.eastmoney.com/api/qt/stock/trends2/get?fields1=f1&fields2=f51,f52,f53,f54,f55,f56,f57&ut=fa5fd1943c7b386f172d6893dbfba10b&ndays=1&iscr=0&secid=0.000001&cb=jQuery112406290464117319126_1645838221914&_=1645838221952';
    
    fetch(testUrl, {
        method: 'GET',
        mode: 'no-cors', // é¿å…CORSé—®é¢˜
        cache: 'no-cache'
    })
    .then(() => {
        statusElement.textContent = 'ä¸œæ–¹è´¢å¯Œç½‘ï¼ˆå¯è®¿é—®ï¼‰';
        statusElement.style.color = '#10b981';
    })
    .catch(error => {
        statusElement.textContent = 'ä¸œæ–¹è´¢å¯Œç½‘ï¼ˆæ£€æµ‹ä¸­...ï¼‰';
        statusElement.style.color = '#f59e0b';
    });
}

// ä»ç¼“å­˜æ›´æ–°ä¸‹è½½çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸è°ƒç”¨APIï¼‰
function updateDownloadStatusDisplayFromCache() {
    const statusElement = document.getElementById('downloadStatusText');
    const status = lastDownloadStatus.status;
    const progress = lastDownloadStatus.progress;
    
    if (status === 'æœªå¼€å§‹') {
        statusElement.textContent = 'å‡†å¤‡å°±ç»ª';
        statusElement.style.color = '#6b7280';
    } else if (status === 'è¿›è¡Œä¸­') {
        statusElement.textContent = `ä¸‹è½½ä¸­ (${progress}%)`;
        statusElement.style.color = '#3b82f6';
    } else if (status === 'å·²å®Œæˆ') {
        statusElement.textContent = 'ä¸‹è½½å®Œæˆ';
        statusElement.style.color = '#10b981';
    } else if (status === 'å·²åœæ­¢') {
        statusElement.textContent = 'å·²åœæ­¢';
        statusElement.style.color = '#ef4444';
    } else {
        statusElement.textContent = status;
        statusElement.style.color = '#6b7280';
    }
}

// æ›´æ–°ä¸‹è½½çŠ¶æ€æ˜¾ç¤ºï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰
function updateDownloadStatusDisplay() {
    // ç°åœ¨ç›´æ¥ä»ç¼“å­˜æ›´æ–°ï¼Œä¸å†è°ƒç”¨API
    updateDownloadStatusDisplayFromCache();
}

// æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
function clearAllPolling() {
    if (polling) {
        clearInterval(polling);
        polling = null;
        console.log('[DEBUG] æ¸…ç†ä¸‹è½½çŠ¶æ€è½®è¯¢');
    }
    if (statsPolling) {
        clearInterval(statsPolling);
        statsPolling = null;
        console.log('[DEBUG] æ¸…ç†ç»Ÿè®¡æ•°æ®è½®è¯¢');
    }
    if (detailsPolling) {
        clearInterval(detailsPolling);
        detailsPolling = null;
        console.log('[DEBUG] æ¸…ç†è¯¦ç»†ä¿¡æ¯è½®è¯¢');
    }
    if (networkPolling) {
        clearInterval(networkPolling);
        networkPolling = null;
        console.log('[DEBUG] æ¸…ç†ç½‘ç»œçŠ¶æ€è½®è¯¢');
    }
    if (dataSourcePolling) {
        clearInterval(dataSourcePolling);
        dataSourcePolling = null;
        console.log('[DEBUG] æ¸…ç†æ•°æ®æºçŠ¶æ€è½®è¯¢');
    }
    // statusDisplayPolling å·²åºŸå¼ƒï¼Œä¸å†éœ€è¦æ¸…ç†
}

// å¯åŠ¨åŸºç¡€è½®è¯¢ï¼ˆä½é¢‘ï¼‰
function startBasicPolling() {
    console.log('[DEBUG] å‡†å¤‡å¯åŠ¨åŸºç¡€è½®è¯¢...');
    
    // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡æ•°æ®ï¼ˆä½é¢‘ï¼‰
    if (statsPolling) {
        clearInterval(statsPolling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„ç»Ÿè®¡æ•°æ®è½®è¯¢');
    }
    statsPolling = setInterval(updateStatistics, 5000);
    console.log('[DEBUG] å¯åŠ¨ä½é¢‘ç»Ÿè®¡æ•°æ®è½®è¯¢ï¼Œé—´éš”5ç§’');
    
    // æ¯10ç§’æ£€æµ‹ä¸€æ¬¡ç½‘ç»œçŠ¶æ€
    if (networkPolling) {
        clearInterval(networkPolling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„ç½‘ç»œçŠ¶æ€è½®è¯¢');
    }
    networkPolling = setInterval(checkNetworkStatus, 10000);
    console.log('[DEBUG] ç½‘ç»œçŠ¶æ€æ£€æµ‹å·²å¯åŠ¨ï¼Œé—´éš”10ç§’');
    
    // æ¯15ç§’æ£€æµ‹ä¸€æ¬¡æ•°æ®æºçŠ¶æ€
    if (dataSourcePolling) {
        clearInterval(dataSourcePolling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„æ•°æ®æºçŠ¶æ€è½®è¯¢');
    }
    dataSourcePolling = setInterval(checkDataSourceStatus, 15000);
    console.log('[DEBUG] æ•°æ®æºçŠ¶æ€æ£€æµ‹å·²å¯åŠ¨ï¼Œé—´éš”15ç§’');
}

// å¯åŠ¨é«˜é¢‘è½®è¯¢ï¼ˆä¸‹è½½æ—¶ä½¿ç”¨ï¼‰
function startHighFrequencyPolling() {
    console.log('[DEBUG] å‡†å¤‡å¯åŠ¨é«˜é¢‘è½®è¯¢ï¼Œå…ˆæ¸…ç†ç°æœ‰å®šæ—¶å™¨...');
    
    // å…ˆæ¸…ç†æ‰€æœ‰ç°æœ‰çš„å®šæ—¶å™¨ï¼Œé¿å…é‡å¤
    if (polling) {
        clearInterval(polling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„ä¸‹è½½çŠ¶æ€è½®è¯¢');
    }
    if (detailsPolling) {
        clearInterval(detailsPolling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„è¯¦ç»†ä¿¡æ¯è½®è¯¢');
    }
    // statusDisplayPolling å·²åºŸå¼ƒï¼Œä¸å†éœ€è¦æ¸…ç†
    if (statsPolling) {
        clearInterval(statsPolling);
        console.log('[DEBUG] æ¸…ç†ç°æœ‰çš„ç»Ÿè®¡æ•°æ®è½®è¯¢');
    }
    
    // å¯åŠ¨é«˜é¢‘è½®è¯¢
    polling = setInterval(updateStatus, 1000);
    console.log('[DEBUG] å¯åŠ¨ä¸‹è½½çŠ¶æ€è½®è¯¢ï¼Œé—´éš”1ç§’');
    
    detailsPolling = setInterval(updateDownloadDetails, 1000);
    console.log('[DEBUG] å¯åŠ¨é«˜é¢‘è¯¦ç»†ä¿¡æ¯è½®è¯¢ï¼Œé—´éš”1ç§’');
    
    statsPolling = setInterval(updateStatistics, 1000);
    console.log('[DEBUG] å¯åŠ¨é«˜é¢‘ç»Ÿè®¡æ•°æ®è½®è¯¢ï¼Œé—´éš”1ç§’');
    
    // statusDisplayPolling ä¸å†éœ€è¦ï¼Œå› ä¸ºçŠ¶æ€æ˜¾ç¤ºå·²åˆå¹¶åˆ°updateStatusä¸­
    console.log('[DEBUG] çŠ¶æ€æ˜¾ç¤ºå·²åˆå¹¶åˆ°updateStatusï¼Œä¸å†éœ€è¦å•ç‹¬è½®è¯¢');
}

// é‡ç½®å¤±è´¥çš„è‚¡ç¥¨ä¸ºå¾…ä¸‹è½½çŠ¶æ€
function resetFailedStocks() {
    console.log('[DEBUG] å¼€å§‹é‡ç½®å¤±è´¥çš„è‚¡ç¥¨...');
    addLog('æ­£åœ¨é‡ç½®å¤±è´¥çš„è‚¡ç¥¨ä¸ºå¾…ä¸‹è½½çŠ¶æ€...', 'info');
    
    fetch('{{ url_for("download_data_bp.reset_failed_stocks") }}', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            console.log('[DEBUG] é‡ç½®å¤±è´¥è‚¡ç¥¨ç»“æœ:', data);
            if (data.reset_count > 0) {
                addLog(`æˆåŠŸé‡ç½® ${data.reset_count} æ¡å¤±è´¥è®°å½•ä¸ºå¾…ä¸‹è½½çŠ¶æ€`, 'success');
                updateStatistics(); // ç«‹å³æ›´æ–°ç»Ÿè®¡æ•°æ®
            } else {
                addLog('æ²¡æœ‰éœ€è¦é‡ç½®çš„å¤±è´¥è®°å½•', 'info');
            }
        })
        .catch(error => {
            console.error('é‡ç½®å¤±è´¥è‚¡ç¥¨å¤±è´¥:', error);
            addLog('é‡ç½®å¤±è´¥è‚¡ç¥¨å¤±è´¥: ' + error.message, 'error');
        });
}

// é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // é¡µé¢åŠ è½½æ—¶é‡ç½®å¤±è´¥çš„è‚¡ç¥¨
    resetFailedStocks();
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ›´æ–°
    updateStatistics();
    updateDownloadDetails();
    checkNetworkStatus();
    checkDataSourceStatus();
    updateDownloadStatusDisplay();
    
    console.log('[DEBUG] å¯åŠ¨åŸºç¡€è½®è¯¢ï¼ˆä½é¢‘ï¼‰...');
    
    // å¯åŠ¨åŸºç¡€è½®è¯¢ï¼ˆä½é¢‘ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼‰
    startBasicPolling();
    
    console.log('[DEBUG] åŸºç¡€è½®è¯¢å·²å¯åŠ¨å®Œæˆ');
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    console.log('[DEBUG] é¡µé¢å³å°†å¸è½½ï¼Œæ¸…ç†æ‰€æœ‰å®šæ—¶å™¨...');
    clearAllPolling();
});

document.getElementById('startBtn').onclick = function() {
    // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
    successStocks = [];
    failedStocks = [];
    downloadLogs = [];
    updateSuccessList();
    updateFailedList();
    updateLogs();
    
    addLog('å¼€å§‹ä¸‹è½½ä»»åŠ¡...', 'info');
    
    // å¼€å§‹ä¸‹è½½å‰å…ˆé‡ç½®å¤±è´¥çš„è‚¡ç¥¨
    resetFailedStocks();
    
    fetch('{{ url_for("download_data_bp.start_download") }}', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            addLog('ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨', 'success');
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            updateStatus();
            updateStatistics();
            updateDownloadDetails();
            
            // å¯åŠ¨é«˜é¢‘è½®è¯¢ï¼ˆä¸‹è½½æ—¶ä½¿ç”¨ï¼‰
            console.log('[DEBUG] å¯åŠ¨é«˜é¢‘è½®è¯¢...');
            startHighFrequencyPolling();
        })
        .catch(error => {
            console.error('å¼€å§‹ä¸‹è½½å¤±è´¥:', error);
            addLog('å¯åŠ¨ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
        });
};

document.getElementById('stopBtn').onclick = function() {
    addLog('è¯·æ±‚åœæ­¢ä¸‹è½½...', 'warning');
    
    fetch('{{ url_for("download_data_bp.stop_download_request") }}', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            document.getElementById('stopBtn').disabled = true;
            addLog('åœæ­¢è¯·æ±‚å·²å‘é€', 'warning');
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            updateStatistics();
            updateDownloadDetails();
            
            // æ¸…ç†é«˜é¢‘è½®è¯¢ï¼Œå›åˆ°åŸºç¡€è½®è¯¢
            console.log('[DEBUG] æ¸…ç†é«˜é¢‘è½®è¯¢ï¼Œå›åˆ°åŸºç¡€è½®è¯¢...');
            clearInterval(polling);
            clearInterval(detailsPolling);
            polling = null;
            detailsPolling = null;
            // statusDisplayPolling å·²åºŸå¼ƒï¼Œä¸å†éœ€è¦æ¸…ç†
            
            // æ¢å¤åŸºç¡€è½®è¯¢
            startBasicPolling();
        })
        .catch(error => {
            console.error('åœæ­¢ä¸‹è½½å¤±è´¥:', error);
            addLog('åœæ­¢ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
        });
};

document.getElementById('resampleBtn').onclick = function() {
    const btn = document.getElementById('resampleBtn');
    const originalText = btn.textContent;
    
    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.disabled = true;
    btn.textContent = 'é‡æ–°é‡‡æ ·ä¸­...';
    addLog('å¼€å§‹é‡æ–°é‡‡æ ·1åˆ†é’Ÿæ•°æ®ä¸ºæ—¥çº¿æ•°æ®...', 'info');
    
    fetch('{{ url_for("download_data_bp.resample_to_daily") }}', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                addLog(data.message, 'success');
                console.log('é‡æ–°é‡‡æ ·ç»“æœ:', data);
            } else {
                addLog('é‡æ–°é‡‡æ ·å¤±è´¥: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('é‡æ–°é‡‡æ ·å¤±è´¥:', error);
            addLog('é‡æ–°é‡‡æ ·å¤±è´¥: ' + error.message, 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            btn.textContent = originalText;
        });
};

document.getElementById('openFolderBtn').onclick = function() {
    fetch('{{ url_for("download_data_bp.open_data_folder") }}', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                console.log('æ•°æ®æ–‡ä»¶å¤¹å·²æ‰“å¼€');
            } else {
                alert('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥:', error);
            alert('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
        });
};
</script>
{% endblock %} 