{% extends "base.html" %}

{% block title %}åŸºé‡‘æ•°æ®åˆ†æ{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>ğŸ“Š åŸºé‡‘æŒä»“æ•°æ®åˆ†æ</h1>
        <p>åŸºäºå‰500åªåŸºé‡‘é‡ä»“æ•°æ®çš„æ·±åº¦åˆ†æå·¥å…·</p>
    </div>

    <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
    <div class="date-selector">
        <div class="form-group">
            <label for="dateSelect">é€‰æ‹©åˆ†ææ—¥æœŸï¼š</label>
            <select id="dateSelect" class="form-control">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
            <button id="refreshBtn" class="btn btn-primary">åˆ·æ–°æ•°æ®</button>
            <button id="saveToDailyBtn" class="btn btn-success">ä¿å­˜åˆ°æ—¥çº¿æ•°æ®</button>
        </div>
    </div>

    <!-- æ¦‚è§ˆç»Ÿè®¡ -->
    <div class="overview-section">
        <h2>ğŸ“ˆ æ•°æ®æ¦‚è§ˆ</h2>
        <p class="analysis-note">ğŸ’¡ åˆ†æåŸºäºå‰500åªåŸºé‡‘çš„é‡ä»“æ•°æ®</p>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalFunds">-</div>
                <div class="stat-label">åŸºé‡‘æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStocks">-</div>
                <div class="stat-label">è‚¡ç¥¨æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">-</div>
                <div class="stat-label">æŒä»“è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgHoldings">-</div>
                <div class="stat-label">å¹³å‡æŒä»“æ•°</div>
            </div>
        </div>
    </div>

    <!-- åˆ†ææ ‡ç­¾é¡µ -->
    <div class="analysis-tabs">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="hot-stocks">ğŸ”¥ çƒ­é—¨è‚¡ç¥¨</button>
            <button class="tab-btn" data-tab="fund-distribution">ğŸ“Š åŸºé‡‘åˆ†å¸ƒ</button>
            <button class="tab-btn" data-tab="industry-analysis">ğŸ­ è¡Œä¸šåˆ†æ</button>
            <button class="tab-btn" data-tab="trend-analysis">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</button>
        </div>

        <!-- çƒ­é—¨è‚¡ç¥¨åˆ†æ -->
        <div class="tab-content active" id="hot-stocks">
            <h3>ğŸ”¥ çƒ­é—¨è‚¡ç¥¨åˆ†æ</h3>
            <p class="description">è¢«æœ€å¤šåŸºé‡‘æŒæœ‰çš„è‚¡ç¥¨æ’è¡Œ</p>
            <div class="loading" id="hotStocksLoading">åŠ è½½ä¸­...</div>
            <div class="data-table" id="hotStocksTable" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>æŒæœ‰åŸºé‡‘æ•°</th>
                            <th>å¹³å‡æŒä»“æ¯”ä¾‹</th>
                            <th>æ€»æŒä»“æ¯”ä¾‹</th>
                            <th>æœ€å¤§æŒä»“æ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody id="hotStocksBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åŸºé‡‘åˆ†å¸ƒåˆ†æ -->
        <div class="tab-content" id="fund-distribution">
            <h3>ğŸ“Š åŸºé‡‘åˆ†å¸ƒåˆ†æ</h3>
            <p class="description">åŸºé‡‘æŒä»“è‚¡ç¥¨æ•°é‡çš„åˆ†å¸ƒæƒ…å†µ</p>
            <div class="loading" id="fundDistLoading">åŠ è½½ä¸­...</div>
            <div class="data-content" id="fundDistContent" style="display: none;">
                <div class="distribution-chart">
                    <h4>æŒä»“è‚¡ç¥¨æ•°é‡åˆ†å¸ƒ</h4>
                    <div class="chart-container" id="distributionChart">
                        <!-- åˆ†å¸ƒå›¾è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    </div>
                </div>
                <div class="top-funds">
                    <h4>æŒä»“è‚¡ç¥¨æœ€å¤šçš„åŸºé‡‘</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>åŸºé‡‘ä»£ç </th>
                                <th>åŸºé‡‘åç§°</th>
                                <th>æŒä»“è‚¡ç¥¨æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="topFundsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è¡Œä¸šåˆ†æ -->
        <div class="tab-content" id="industry-analysis">
            <h3>ğŸ­ è¡Œä¸šåˆ†æ</h3>
            <p class="description">åŸºäºè‚¡ç¥¨å¸‚åœºçš„è¡Œä¸šåˆ†å¸ƒåˆ†æ</p>
            <div class="loading" id="industryLoading">åŠ è½½ä¸­...</div>
            <div class="data-content" id="industryContent" style="display: none;">
                <div class="market-stats">
                    <h4>å¸‚åœºåˆ†å¸ƒç»Ÿè®¡</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>å¸‚åœº</th>
                                <th>è‚¡ç¥¨æ•°é‡</th>
                                <th>åŸºé‡‘æ•°é‡</th>
                                <th>å¹³å‡æŒä»“æ¯”ä¾‹</th>
                                <th>æ€»æŒä»“æ¯”ä¾‹</th>
                            </tr>
                        </thead>
                        <tbody id="marketStatsBody">
                        </tbody>
                    </table>
                </div>
                <div class="market-hot-stocks">
                    <h4>å„å¸‚åœºçƒ­é—¨è‚¡ç¥¨</h4>
                    <div id="marketHotStocks">
                        <!-- å„å¸‚åœºçƒ­é—¨è‚¡ç¥¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>

        <!-- è¶‹åŠ¿åˆ†æ -->
        <div class="tab-content" id="trend-analysis">
            <h3>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h3>
            <p class="description">å¤šæ—¥æœŸæ•°æ®å¯¹æ¯”åˆ†æ</p>
            <div class="loading" id="trendLoading">åŠ è½½ä¸­...</div>
            <div class="data-content" id="trendContent" style="display: none;">
                <div class="trend-chart">
                    <h4>è¶‹åŠ¿å›¾è¡¨</h4>
                    <div class="chart-container" id="trendChart">
                        <!-- è¶‹åŠ¿å›¾è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    </div>
                </div>
                <div class="trend-table">
                    <h4>è¶‹åŠ¿æ•°æ®</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>åŸºé‡‘æ€»æ•°</th>
                                <th>è‚¡ç¥¨æ€»æ•°</th>
                                <th>æŒä»“è®°å½•</th>
                                <th>å¹³å‡æŒä»“æ•°</th>
                                <th>çƒ­é—¨è‚¡ç¥¨</th>
                            </tr>
                        </thead>
                        <tbody id="trendDataBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}

.header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
}

.header p {
    margin: 0;
    opacity: 0.9;
}

.analysis-note {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 5px;
    padding: 10px 15px;
    margin: 10px 0 20px 0;
    color: #1976d2;
    font-size: 14px;
    text-align: center;
}

.date-selector {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-group {
    display: flex;
    align-items: center;
    gap: 15px;
}

.form-group label {
    font-weight: 600;
    color: #333;
}

.form-control {
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    min-width: 150px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.overview-section {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.overview-section h2 {
    margin: 0 0 20px 0;
    color: #333;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.analysis-tabs {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.tab-nav {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.tab-btn {
    flex: 1;
    padding: 15px 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    color: #666;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: white;
    color: #007bff;
    border-bottom: 3px solid #007bff;
}

.tab-btn:hover {
    background: #e9ecef;
}

.tab-content {
    display: none;
    padding: 30px;
}

.tab-content.active {
    display: block;
}

.tab-content h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.description {
    color: #666;
    margin-bottom: 25px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 16px;
}

.data-table, .data-content {
    margin-top: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

tr:hover {
    background: #f8f9fa;
}

.distribution-chart, .trend-chart {
    margin-bottom: 30px;
}

.chart-container {
    height: 300px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 10px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 15px;
}

.close:hover {
    color: #000;
}

@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .tab-nav {
        flex-direction: column;
    }
    
    .tab-btn {
        border-bottom: 1px solid #dee2e6;
    }
    
    .form-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    table {
        font-size: 14px;
    }
    
    th, td {
        padding: 8px 10px;
    }
}
</style>

<script>
let currentDate = '';
let availableDates = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
    loadAvailableDates();
    setupEventListeners();
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    // æ—¥æœŸé€‰æ‹©å™¨
    document.getElementById('dateSelect').addEventListener('change', function() {
        currentDate = this.value;
        if (currentDate) {
            loadOverviewData();
            loadActiveTabData();
        }
    });
    
    // åˆ·æ–°æŒ‰é’®
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadAvailableDates();
    });
    
    // ä¿å­˜åˆ°æ—¥çº¿æ•°æ®æŒ‰é’®
    document.getElementById('saveToDailyBtn').addEventListener('click', function() {
        saveFundHoldingsToDaily();
    });
    
    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchTab(this.dataset.tab);
        });
    });
    
    // æ¨¡æ€æ¡†å…³é—­
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('detailModal').style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// åŠ è½½å¯ç”¨æ—¥æœŸ
async function loadAvailableDates() {
    console.log('[DEBUG] å¼€å§‹åŠ è½½å¯ç”¨æ—¥æœŸ');
    try {
        const response = await fetch('/funds/analysis/api/get_available_dates');
        console.log('[DEBUG] æ—¥æœŸAPIå“åº”çŠ¶æ€:', response.status);
        const data = await response.json();
        console.log('[DEBUG] æ—¥æœŸAPIå“åº”æ•°æ®:', data);
        
        if (data.success) {
            availableDates = data.dates;
            console.log('[DEBUG] å¯ç”¨æ—¥æœŸ:', availableDates);
            updateDateSelector();
            
            // é»˜è®¤é€‰æ‹©æœ€æ–°æ—¥æœŸ
            if (availableDates.length > 0) {
                currentDate = availableDates[0];
                console.log('[DEBUG] é€‰æ‹©é»˜è®¤æ—¥æœŸ:', currentDate);
                document.getElementById('dateSelect').value = currentDate;
                loadOverviewData();
                loadActiveTabData();
            }
        } else {
            console.error('åŠ è½½å¯ç”¨æ—¥æœŸå¤±è´¥:', data.error);
        }
    } catch (error) {
        console.error('åŠ è½½å¯ç”¨æ—¥æœŸå‡ºé”™:', error);
    }
}

// æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
function updateDateSelector() {
    const select = document.getElementById('dateSelect');
    select.innerHTML = '';
    
    availableDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formatDate(date);
        select.appendChild(option);
    });
}

// æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
function formatDate(dateStr) {
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${year}-${month}-${day}`;
}

// åŠ è½½æ¦‚è§ˆæ•°æ®
async function loadOverviewData() {
    if (!currentDate) return;
    
    try {
        // é€šè¿‡çƒ­é—¨è‚¡ç¥¨APIè·å–æ¦‚è§ˆæ•°æ®
        const response = await fetch(`/funds/analysis/api/hot_stocks?date=${currentDate}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalFunds').textContent = data.total_funds;
            document.getElementById('totalStocks').textContent = data.total_stocks;
            document.getElementById('totalRecords').textContent = data.total_stocks; // è¿™é‡Œéœ€è¦ä»APIè¿”å›
            document.getElementById('avgHoldings').textContent = Math.round(data.total_stocks / data.total_funds * 10) / 10;
        } else {
            console.error('è·å–æ¦‚è§ˆæ•°æ®å¤±è´¥:', data.error);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            document.getElementById('totalFunds').textContent = 'N/A';
            document.getElementById('totalStocks').textContent = 'N/A';
            document.getElementById('totalRecords').textContent = 'N/A';
            document.getElementById('avgHoldings').textContent = 'N/A';
        }
    } catch (error) {
        console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å‡ºé”™:', error);
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        document.getElementById('totalFunds').textContent = 'Error';
        document.getElementById('totalStocks').textContent = 'Error';
        document.getElementById('totalRecords').textContent = 'Error';
        document.getElementById('avgHoldings').textContent = 'Error';
    }
}

// åŠ è½½å½“å‰æ´»è·ƒæ ‡ç­¾é¡µçš„æ•°æ®
function loadActiveTabData() {
    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
    loadTabData(activeTab);
}

// åŠ è½½æ ‡ç­¾é¡µæ•°æ®
async function loadTabData(tabName) {
    let loadingElement, contentElement;
    
    // æ ¹æ®æ ‡ç­¾é¡µåç§°è·å–å¯¹åº”çš„å…ƒç´ ID
    switch (tabName) {
        case 'hot-stocks':
            loadingElement = document.getElementById('hotStocksLoading');
            contentElement = document.getElementById('hotStocksTable');
            break;
        case 'fund-distribution':
            loadingElement = document.getElementById('fundDistLoading');
            contentElement = document.getElementById('fundDistContent');
            break;
        case 'industry-analysis':
            loadingElement = document.getElementById('industryLoading');
            contentElement = document.getElementById('industryContent');
            break;
        case 'trend-analysis':
            loadingElement = document.getElementById('trendLoading');
            contentElement = document.getElementById('trendContent');
            break;
    }
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    
    try {
        let response;
        switch (tabName) {
            case 'hot-stocks':
                response = await fetch(`/funds/analysis/api/hot_stocks?date=${currentDate}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderHotStocks(data.top_stocks);
                    } else {
                        console.error('APIè¿”å›å¤±è´¥:', data.error);
                    }
                } else {
                    console.error('HTTPè¯·æ±‚å¤±è´¥:', response.status);
                }
                break;
            case 'fund-distribution':
                response = await fetch(`/funds/analysis/api/fund_distribution?date=${currentDate}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderFundDistribution(data);
                    } else {
                        console.error('APIè¿”å›å¤±è´¥:', data.error);
                    }
                } else {
                    console.error('HTTPè¯·æ±‚å¤±è´¥:', response.status);
                }
                break;
            case 'industry-analysis':
                response = await fetch(`/funds/analysis/api/industry_analysis?date=${currentDate}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderIndustryAnalysis(data);
                    } else {
                        console.error('APIè¿”å›å¤±è´¥:', data.error);
                    }
                } else {
                    console.error('HTTPè¯·æ±‚å¤±è´¥:', response.status);
                }
                break;
            case 'trend-analysis':
                response = await fetch(`/funds/analysis/api/trend_analysis?days=7`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderTrendAnalysis(data);
                    } else {
                        console.error('APIè¿”å›å¤±è´¥:', data.error);
                    }
                } else {
                    console.error('HTTPè¯·æ±‚å¤±è´¥:', response.status);
                }
                break;
        }
    } catch (error) {
        console.error(`åŠ è½½${tabName}æ•°æ®å‡ºé”™:`, error);
        if (loadingElement) {
            loadingElement.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}`;
        }
    } finally {
        if (loadingElement) loadingElement.style.display = 'none';
        if (contentElement) contentElement.style.display = 'block';
    }
}

// æ¸²æŸ“çƒ­é—¨è‚¡ç¥¨æ•°æ®
function renderHotStocks(topStocks) {
    console.log('[DEBUG] å¼€å§‹æ¸²æŸ“çƒ­é—¨è‚¡ç¥¨æ•°æ®:', topStocks);
    const tbody = document.getElementById('hotStocksBody');
    if (!tbody) {
        console.error('[DEBUG] æ‰¾ä¸åˆ°hotStocksBodyå…ƒç´ ');
        return;
    }
    tbody.innerHTML = '';
    
    if (!topStocks || topStocks.length === 0) {
        console.warn('[DEBUG] çƒ­é—¨è‚¡ç¥¨æ•°æ®ä¸ºç©º');
        return;
    }
    
    topStocks.forEach((stock, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td><a href="#" onclick="showStockDetail('${stock.stock_code}')">${stock.stock_code}</a></td>
            <td>${stock.stock_name}</td>
            <td>${stock.fund_count}</td>
            <td>${stock.avg_ratio}%</td>
            <td>${stock.total_ratio}%</td>
            <td>${stock.max_ratio}%</td>
        `;
        tbody.appendChild(row);
    });
    console.log('[DEBUG] çƒ­é—¨è‚¡ç¥¨æ•°æ®æ¸²æŸ“å®Œæˆï¼Œå…±', topStocks.length, 'æ¡è®°å½•');
}

// æ¸²æŸ“åŸºé‡‘åˆ†å¸ƒæ•°æ®
function renderFundDistribution(data) {
    // æ¸²æŸ“æŒä»“æœ€å¤šçš„åŸºé‡‘
    const topFundsBody = document.getElementById('topFundsBody');
    topFundsBody.innerHTML = '';
    
    data.top_funds.forEach(fund => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="showFundDetail('${fund.fund_code}')">${fund.fund_code}</a></td>
            <td>${fund.fund_name}</td>
            <td>${fund.stock_count}</td>
        `;
        topFundsBody.appendChild(row);
    });
    
    // æ¸²æŸ“åˆ†å¸ƒç»Ÿè®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
    const distributionChart = document.getElementById('distributionChart');
    distributionChart.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <h4>åˆ†å¸ƒç»Ÿè®¡</h4>
            <p>å¹³å‡æŒä»“è‚¡ç¥¨æ•°: ${data.distribution_stats.mean?.toFixed(1) || 'N/A'}</p>
            <p>æœ€å¤šæŒä»“è‚¡ç¥¨æ•°: ${data.distribution_stats.max || 'N/A'}</p>
            <p>æœ€å°‘æŒä»“è‚¡ç¥¨æ•°: ${data.distribution_stats.min || 'N/A'}</p>
        </div>
    `;
}

// æ¸²æŸ“è¡Œä¸šåˆ†ææ•°æ®
function renderIndustryAnalysis(data) {
    // æ¸²æŸ“å¸‚åœºç»Ÿè®¡
    const marketStatsBody = document.getElementById('marketStatsBody');
    marketStatsBody.innerHTML = '';
    
    data.market_stats.forEach(market => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${market.market}</td>
            <td>${market.stock_count}</td>
            <td>${market.fund_count}</td>
            <td>${market.avg_ratio}%</td>
            <td>${market.total_ratio}%</td>
        `;
        marketStatsBody.appendChild(row);
    });
    
    // æ¸²æŸ“å„å¸‚åœºçƒ­é—¨è‚¡ç¥¨
    const marketHotStocks = document.getElementById('marketHotStocks');
    marketHotStocks.innerHTML = '';
    
    Object.keys(data.market_hot_stocks).forEach(market => {
        const marketDiv = document.createElement('div');
        marketDiv.innerHTML = `
            <h5>${market}</h5>
            <ul>
                ${data.market_hot_stocks[market].map(stock => 
                    `<li><a href="#" onclick="showStockDetail('${stock.stock_code}')">${stock.stock_name} (${stock.stock_code})</a> - ${stock.fund_count}ä¸ªåŸºé‡‘æŒæœ‰</li>`
                ).join('')}
            </ul>
        `;
        marketHotStocks.appendChild(marketDiv);
    });
}

// æ¸²æŸ“è¶‹åŠ¿åˆ†ææ•°æ®
function renderTrendAnalysis(data) {
    // æ¸²æŸ“è¶‹åŠ¿æ•°æ®è¡¨æ ¼
    const trendDataBody = document.getElementById('trendDataBody');
    trendDataBody.innerHTML = '';
    
    data.trend_data.forEach(trend => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(trend.date)}</td>
            <td>${trend.total_funds}</td>
            <td>${trend.total_stocks}</td>
            <td>${trend.total_records}</td>
            <td>${trend.avg_holdings_per_fund}</td>
            <td>${Object.keys(trend.top_stocks).slice(0, 3).join(', ')}</td>
        `;
        trendDataBody.appendChild(row);
    });
    
    // ç®€åŒ–çš„è¶‹åŠ¿å›¾è¡¨
    const trendChart = document.getElementById('trendChart');
    trendChart.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <h4>è¶‹åŠ¿æ¦‚è§ˆ</h4>
            <p>åˆ†ææœŸé—´: ${data.days} å¤©</p>
            <p>æ•°æ®ç‚¹æ•°: ${data.trend_data.length}</p>
        </div>
    `;
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // æ›´æ–°æ ‡ç­¾å†…å®¹æ˜¾ç¤º
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    
    // åŠ è½½å¯¹åº”æ ‡ç­¾é¡µæ•°æ®
    loadTabData(tabName);
}

// æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ…
async function showStockDetail(stockCode) {
    try {
        const response = await fetch(`/funds/analysis/api/stock_detail/${stockCode}?date=${currentDate}`);
        const data = await response.json();
        
        if (data.success) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h3>è‚¡ç¥¨è¯¦æƒ…: ${data.stock_info.stock_name} (${data.stock_info.stock_code})</h3>
                <div class="stock-info">
                    <p><strong>æŒæœ‰åŸºé‡‘æ•°:</strong> ${data.stock_info.fund_count}</p>
                    <p><strong>æ€»æŒä»“æ¯”ä¾‹:</strong> ${data.stock_info.total_ratio}%</p>
                    <p><strong>å¹³å‡æŒä»“æ¯”ä¾‹:</strong> ${data.stock_info.avg_ratio}%</p>
                    <p><strong>æœ€å¤§æŒä»“æ¯”ä¾‹:</strong> ${data.stock_info.max_ratio}%</p>
                    <p><strong>æœ€å°æŒä»“æ¯”ä¾‹:</strong> ${data.stock_info.min_ratio}%</p>
                </div>
                <h4>æŒæœ‰åŸºé‡‘åˆ—è¡¨:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>åŸºé‡‘ä»£ç </th>
                            <th>åŸºé‡‘åç§°</th>
                            <th>æŒä»“æ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.holdings.map(holding => `
                            <tr>
                                <td>${holding.fund_code}</td>
                                <td>${holding.fund_name}</td>
                                <td>${holding.holdings_ratio}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }
    } catch (error) {
        console.error('è·å–è‚¡ç¥¨è¯¦æƒ…å¤±è´¥:', error);
        alert('è·å–è‚¡ç¥¨è¯¦æƒ…å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºåŸºé‡‘è¯¦æƒ…
async function showFundDetail(fundCode) {
    try {
        const response = await fetch(`/funds/analysis/api/fund_detail/${fundCode}?date=${currentDate}`);
        const data = await response.json();
        
        if (data.success) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h3>åŸºé‡‘è¯¦æƒ…: ${data.fund_info.fund_name} (${data.fund_info.fund_code})</h3>
                <div class="fund-info">
                    <p><strong>æŒä»“è‚¡ç¥¨æ•°:</strong> ${data.fund_info.stock_count}</p>
                    <p><strong>æ€»æŒä»“æ¯”ä¾‹:</strong> ${data.fund_info.total_ratio}%</p>
                    <p><strong>å¹³å‡æŒä»“æ¯”ä¾‹:</strong> ${data.fund_info.avg_ratio}%</p>
                    <p><strong>æœ€å¤§æŒä»“æ¯”ä¾‹:</strong> ${data.fund_info.max_ratio}%</p>
                    <p><strong>å‰10å¤§æŒä»“å æ¯”:</strong> ${data.top10_ratio}%</p>
                </div>
                <h4>æŒä»“æ˜ç»†:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>æŒä»“æ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.holdings.map(holding => `
                            <tr>
                                <td><a href="#" onclick="showStockDetail('${holding.stock_code}')">${holding.stock_code}</a></td>
                                <td>${holding.stock_name}</td>
                                <td>${holding.holdings_ratio}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }
    } catch (error) {
        console.error('è·å–åŸºé‡‘è¯¦æƒ…å¤±è´¥:', error);
        alert('è·å–åŸºé‡‘è¯¦æƒ…å¤±è´¥: ' + error.message);
    }
}

// ä¿å­˜åŸºé‡‘æŒä»“æ•°æ®åˆ°æ—¥çº¿æ•°æ®è¡¨
async function saveFundHoldingsToDaily() {
    if (!currentDate) {
        alert('è¯·å…ˆé€‰æ‹©åˆ†ææ—¥æœŸ');
        return;
    }
    
    const saveBtn = document.getElementById('saveToDailyBtn');
    const originalText = saveBtn.textContent;
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        saveBtn.disabled = true;
        
        const response = await fetch('/funds/analysis/api/save_fund_holdings_to_daily', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                date: currentDate
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('åŸºé‡‘æŒä»“æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°daily_stock_dataè¡¨ï¼');
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + data.error);
        }
        
    } catch (error) {
        console.error('ä¿å­˜åŸºé‡‘æŒä»“æ•°æ®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}
</script>
{% endblock %}
