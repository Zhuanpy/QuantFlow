{% extends "base.html" %}

{% block content %}
<!-- åŠ è½½Plotly.jsåº“ï¼ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼‰ -->
<script src="{{ url_for('static', filename='js/plotly.min.js') }}"></script>

<div class="container">
    <div class="header">
        <h1>15åˆ†é’Ÿæ•°æ®å¤„ç†</h1>
        <a href="{{ url_for('main_bp.index') }}" class="back-link">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="card">
        <h2>ğŸ“Š æ•°æ®å¤„ç†é…ç½®</h2>
        <form id="dataProcessingForm" class="processing-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="stock_code">è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="stock_code" name="stock_code" placeholder="å¦‚ï¼š002475" required>
                </div>
                
                <div class="form-group">
                    <label for="year">å¹´ä»½</label>
                    <select id="year" name="year" required>
                        <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                        {% for year in range(2020, 2026) %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quarter">å­£åº¦</label>
                    <select id="quarter" name="quarter" required>
                        <option value="">è¯·é€‰æ‹©å­£åº¦</option>
                        <option value="Q1">Q1 (1-3æœˆ)</option>
                        <option value="Q2">Q2 (4-6æœˆ)</option>
                        <option value="Q3">Q3 (7-9æœˆ)</option>
                        <option value="Q4">Q4 (10-12æœˆ)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="processing_type">å¤„ç†ç±»å‹</label>
                    <select id="processing_type" name="processing_type" required>
                        <option value="resample">é‡é‡‡æ ·ä¸º15åˆ†é’Ÿæ•°æ®</option>
                        <option value="signals">é‡é‡‡æ · + ä¿¡å·è®¡ç®—</option>
                        <option value="standardized">é‡é‡‡æ · + ä¿¡å·è®¡ç®— + å®Œæ•´æ ‡å‡†åŒ–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="chart_type">å›¾è¡¨ç±»å‹</label>
                    <select id="chart_type" name="chart_type">
                        <option value="comprehensive">ç»¼åˆåˆ†æå›¾</option>
                        <option value="price">ä»·æ ¼èµ°åŠ¿å›¾</option>
                        <option value="macd">MACDæŒ‡æ ‡å›¾</option>
                        <option value="bollinger">å¸ƒæ—å¸¦æŒ‡æ ‡å›¾</option>
                    </select>
                </div>
            </div>
            
            <div class="data-mode-info">
                <div class="info-card">
                    <h3>ğŸ“‹ æ•°æ®å¤„ç†æ¨¡å¼</h3>
                    <p><strong>è‡ªåŠ¨è¿½åŠ æ¨¡å¼</strong>ï¼šæ–°æ•°æ®ä¼šè‡ªåŠ¨è¿½åŠ åˆ°ç°æœ‰æ–‡ä»¶ä¸­</p>
                    <p><strong>æ™ºèƒ½å»é‡</strong>ï¼šç›¸åŒæ—¥æœŸçš„æ•°æ®ä¼šä¿ç•™æœ€æ–°çš„è®°å½•</p>
                    <p><strong>æ•°æ®å®‰å…¨</strong>ï¼šä¸ä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§</p>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="processBtn">
                    <span class="btn-text">å¼€å§‹å¤„ç†</span>
                    <span class="btn-loading" style="display: none;">å¤„ç†ä¸­...</span>
                </button>
                <button type="button" class="btn btn-secondary" id="checkDataBtn">æ£€æŸ¥æ•°æ®</button>
                <button type="button" class="btn btn-info" id="createChartBtn">ç”Ÿæˆå›¾è¡¨</button>
            </div>
        </form>
    </div>

    <!-- å¤„ç†è¿›åº¦ -->
    <div class="card" id="progressCard" style="display: none;">
        <h2>ğŸ“ˆ å¤„ç†è¿›åº¦</h2>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
        </div>
        
        <div class="progress-steps">
            <div class="step" id="step1">
                <span class="step-icon">1</span>
                <span class="step-text">æ£€æŸ¥1åˆ†é’Ÿæ•°æ®</span>
            </div>
            <div class="step" id="step2">
                <span class="step-icon">2</span>
                <span class="step-text">é‡é‡‡æ ·ä¸º15åˆ†é’Ÿæ•°æ®</span>
            </div>
            <div class="step" id="step3">
                <span class="step-icon">3</span>
                <span class="step-text">æ ‡å‡†åŒ–å¤„ç†</span>
            </div>
            <div class="step" id="step4">
                <span class="step-icon">4</span>
                <span class="step-text">ä¿¡å·è®¡ç®—</span>
            </div>
            <div class="step" id="step5">
                <span class="step-icon">5</span>
                <span class="step-text">ä¿å­˜æ•°æ®</span>
            </div>
        </div>
    </div>

    <!-- å¤„ç†ç»“æœ -->
    <div class="card" id="resultCard" style="display: none;">
        <h2>ğŸ“‹ å¤„ç†ç»“æœ</h2>
        <div class="result-summary" id="resultSummary"></div>
        
        <div class="file-paths" id="filePaths"></div>
        
        <div class="data-statistics" id="dataStatistics"></div>
    </div>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div class="card error-card" id="errorCard" style="display: none;">
        <h2>âŒ å¤„ç†é”™è¯¯</h2>
        <div class="error-content" id="errorContent"></div>
    </div>

    <!-- å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="card" id="chartCard" style="display: none;">
        <h2>ğŸ“ˆ æ•°æ®å¯è§†åŒ–</h2>
        <div id="chartInfo"></div>
        <div id="chartDisplay">
            <img id="chartImage" style="max-width: 100%; height: auto; display: none;">
        </div>
        <div id="chartError" style="display: none;"></div>
    </div>
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header h1 {
        color: var(--text-primary);
        margin: 0;
    }

    .back-link {
        color: var(--primary-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .card {
        background: var(--card-background);
        border-radius: 8px;
        padding: 20px;
        box-shadow: var(--shadow-md);
        margin-bottom: 20px;
    }

    .card h2 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--background-color);
    }

    .processing-form {
        margin-top: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        margin-bottom: 8px;
        color: var(--text-primary);
        font-weight: 500;
    }

    .form-group input,
    .form-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-2px);
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: var(--background-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--background-color);
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
        margin-bottom: 30px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--background-color);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        color: var(--text-primary);
        font-weight: 500;
    }

    .progress-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 6px;
        background: var(--background-secondary);
        transition: all 0.3s ease;
    }

    .step.active {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .step.completed {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .step-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--background-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: var(--text-secondary);
    }

    .step.active .step-icon {
        background: var(--primary-color);
        color: white;
    }

    .step.completed .step-icon {
        background: var(--success-color);
        color: white;
    }

    .step-text {
        color: var(--text-primary);
        font-size: 14px;
    }

    /* ç»“æœæ ·å¼ */
    .result-summary {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .file-paths {
        margin-bottom: 20px;
    }

    .file-path-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .file-path-item:last-child {
        margin-bottom: 0;
    }

    .file-path-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .file-path-text {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: var(--text-secondary);
        background: var(--background-secondary);
        padding: 8px;
        border-radius: 4px;
        word-break: break-all;
    }

    .data-statistics {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 6px;
        padding: 15px;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 5px;
    }

    /* é”™è¯¯æ ·å¼ */
    .error-card {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .error-card h2 {
        color: #dc2626;
    }

    .error-content {
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
    }

    /* æ•°æ®å¤„ç†æ¨¡å¼ä¿¡æ¯å¡ç‰‡ */
    .data-mode-info {
        margin: 1.5rem 0;
    }

    .info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .info-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .info-card p {
        margin: 0.5rem 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .info-card strong {
        font-weight: 600;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .progress-steps {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('dataProcessingForm');
    const processBtn = document.getElementById('processBtn');
    const checkDataBtn = document.getElementById('checkDataBtn');
    const progressCard = document.getElementById('progressCard');
    const resultCard = document.getElementById('resultCard');
    const errorCard = document.getElementById('errorCard');

    // è¡¨å•æäº¤å¤„ç†
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        startProcessing();
    });

    // æ£€æŸ¥æ•°æ®æŒ‰é’®
    checkDataBtn.addEventListener('click', function() {
        checkData();
    });

    function startProcessing() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
        progressCard.style.display = 'block';
        resultCard.style.display = 'none';
        errorCard.style.display = 'none';
        
        // ç¦ç”¨æŒ‰é’®
        processBtn.disabled = true;
        processBtn.querySelector('.btn-text').style.display = 'none';
        processBtn.querySelector('.btn-loading').style.display = 'inline';
        
        // é‡ç½®è¿›åº¦
        resetProgress();
        
        // å‘é€è¯·æ±‚
        fetch('/process_data/api/process_15m_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showResults(data);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            showError('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®
            processBtn.disabled = false;
            processBtn.querySelector('.btn-text').style.display = 'inline';
            processBtn.querySelector('.btn-loading').style.display = 'none';
        });
    }

    function checkData() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        if (!data.stock_code || !data.year || !data.quarter) {
            alert('è¯·å¡«å†™å®Œæ•´çš„è‚¡ç¥¨ä»£ç ã€å¹´ä»½å’Œå­£åº¦ä¿¡æ¯');
            return;
        }
        
        fetch('/process_data/api/check_15m_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`æ•°æ®æ£€æŸ¥å®Œæˆ:\n${data.message}`);
            } else {
                alert(`æ•°æ®æ£€æŸ¥å¤±è´¥:\n${data.message}`);
            }
        })
        .catch(error => {
            alert('æ£€æŸ¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        });
    }

    function resetProgress() {
        const steps = document.querySelectorAll('.step');
        steps.forEach(step => {
            step.classList.remove('active', 'completed');
        });
        
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = 'å‡†å¤‡ä¸­...';
    }

    function updateProgress(step, percentage, text) {
        // æ›´æ–°è¿›åº¦æ¡
        document.getElementById('progressFill').style.width = percentage + '%';
        document.getElementById('progressText').textContent = text;
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        const stepElement = document.getElementById('step' + step);
        if (stepElement) {
            stepElement.classList.add('active');
        }
        
        // å®Œæˆä¹‹å‰çš„æ­¥éª¤
        for (let i = 1; i < step; i++) {
            const prevStep = document.getElementById('step' + i);
            if (prevStep) {
                prevStep.classList.remove('active');
                prevStep.classList.add('completed');
            }
        }
    }

    function showResults(data) {
        progressCard.style.display = 'none';
        resultCard.style.display = 'block';
        
        // æ˜¾ç¤ºç»“æœæ‘˜è¦
        const summary = document.getElementById('resultSummary');
        summary.innerHTML = `
            <h3>âœ… å¤„ç†å®Œæˆ</h3>
            <p><strong>è‚¡ç¥¨ä»£ç :</strong> ${data.stock_code}</p>
            <p><strong>å¤„ç†æ—¶é—´:</strong> ${data.year}-${data.quarter}</p>
            <p><strong>å¤„ç†ç±»å‹:</strong> ${data.processing_type}</p>
            <p><strong>å¤„ç†ç»“æœ:</strong> ${data.message}</p>
        `;
        
        // æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„
        const filePaths = document.getElementById('filePaths');
        if (data.file_paths && data.file_paths.length > 0) {
            filePaths.innerHTML = '<h3>ğŸ“ ä¿å­˜è·¯å¾„</h3>' + 
                data.file_paths.map(path => `
                    <div class="file-path-item">
                        <div class="file-path-label">${path.type}</div>
                        <div class="file-path-text">${path.path}</div>
                    </div>
                `).join('');
        }
        
        // æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
        const statistics = document.getElementById('dataStatistics');
        if (data.statistics) {
            statistics.innerHTML = `
                <h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                <div class="statistics-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.statistics.records_1m || 0}</div>
                        <div class="stat-label">1åˆ†é’Ÿæ•°æ®æ¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.statistics.records_15m || 0}</div>
                        <div class="stat-label">15åˆ†é’Ÿæ•°æ®æ¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.statistics.signals_up || 0}</div>
                        <div class="stat-label">ä¸Šæ¶¨ä¿¡å·</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.statistics.signals_down || 0}</div>
                        <div class="stat-label">ä¸‹è·Œä¿¡å·</div>
                    </div>
                </div>
            `;
        }
    }

    function showError(message) {
        progressCard.style.display = 'none';
        resultCard.style.display = 'none';
        errorCard.style.display = 'block';
        
        document.getElementById('errorContent').textContent = message;
    }

    // å›¾è¡¨ç”ŸæˆåŠŸèƒ½ - äº¤äº’å¼Plotlyå›¾è¡¨
    document.getElementById('createChartBtn').addEventListener('click', async function() {
        const stockCode = document.getElementById('stock_code').value;
        
        if (!stockCode) {
            alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç ');
            return;
        }
        
        const chartCard = document.getElementById('chartCard');
        const chartInfo = document.getElementById('chartInfo');
        const chartImage = document.getElementById('chartImage');
        const chartError = document.getElementById('chartError');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        chartCard.style.display = 'block';
        chartInfo.innerHTML = '<p>ğŸ”„ æ­£åœ¨ç”Ÿæˆäº¤äº’å¼å›¾è¡¨...</p>';
        chartImage.style.display = 'none';
        chartError.style.display = 'none';
        
        try {
            // è·å–å¹´ä»½å’Œå­£åº¦
            const year = document.getElementById('year').value;
            const quarter = document.getElementById('quarter').value;
            
            const response = await fetch('/process_data/api/create_visualization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    stock_code: stockCode,
                    data_type: '15m_normal',  // ä½¿ç”¨æ™®é€šæ•°æ®è€Œä¸æ˜¯æ ‡å‡†åŒ–æ•°æ®
                    year: year,
                    quarter: quarter
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                chartInfo.innerHTML = `
                    <h3>âœ… äº¤äº’å¼å›¾è¡¨ç”ŸæˆæˆåŠŸ</h3>
                    <p><strong>è‚¡ç¥¨ä»£ç :</strong> ${stockCode}</p>
                    <p><strong>æ—¶é—´èŒƒå›´:</strong> ${year}-${quarter}</p>
                    <p><strong>å›¾è¡¨æ•°é‡:</strong> ${Object.keys(result.charts).length} ä¸ª</p>
                    <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    <p class="info-text">ğŸ’¡ å›¾è¡¨æ”¯æŒç¼©æ”¾ã€å¹³ç§»ã€æ‚¬åœæŸ¥çœ‹è¯¦æƒ…ç­‰äº¤äº’æ“ä½œ</p>
                `;
                
                // éšè—æ—§çš„å›¾ç‰‡æ˜¾ç¤º
                chartImage.style.display = 'none';
                chartError.style.display = 'none';
                
                // è·å–å›¾è¡¨æ˜¾ç¤ºå®¹å™¨
                const chartDisplay = document.getElementById('chartDisplay');
                
                // åˆ›å»ºå›¾è¡¨å®¹å™¨
                chartDisplay.innerHTML = '<div class="interactive-charts" style="margin-top: 20px;"></div>';
                const chartsContainer = chartDisplay.querySelector('.interactive-charts');
                
                // æŒ‰é¡ºåºæ˜¾ç¤ºå„ä¸ªå›¾è¡¨
                const chartOrder = ['price', 'macd', 'volume', 'ema'];
                const chartTitles = {
                    'price': 'ğŸ“ˆ ä»·æ ¼èµ°åŠ¿ä¸äº¤æ˜“ä¿¡å·',
                    'macd': 'ğŸ“Š MACDæŒ‡æ ‡åˆ†æ',
                    'volume': 'ğŸ“¦ æˆäº¤é‡åˆ†æ',
                    'ema': 'ğŸ“ EMAå‡çº¿åˆ†æ'
                };
                
                for (const chartKey of chartOrder) {
                    if (result.charts[chartKey]) {
                        console.log(`å¤„ç†å›¾è¡¨: ${chartKey}, HTMLé•¿åº¦: ${result.charts[chartKey].length}`);
                        
                        // åˆ›å»ºå›¾è¡¨åŒºåŸŸå®¹å™¨
                        const chartSection = document.createElement('div');
                        chartSection.className = 'chart-section';
                        chartSection.style.cssText = 'margin-bottom: 30px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: white;';
                        
                        // æ·»åŠ æ ‡é¢˜
                        const title = document.createElement('h4');
                        title.style.cssText = 'color: #2196F3; margin-bottom: 10px;';
                        title.textContent = chartTitles[chartKey];
                        chartSection.appendChild(title);
                        
                        // åˆ›å»ºå›¾è¡¨å®¹å™¨å¹¶æ’å…¥HTML
                        const chartDiv = document.createElement('div');
                        chartDiv.innerHTML = result.charts[chartKey];
                        
                        // æŸ¥æ‰¾å¹¶æ‰§è¡Œå†…è”çš„scriptæ ‡ç­¾ï¼ˆPlotlyå›¾è¡¨çš„å…³é”®ï¼‰
                        const scripts = chartDiv.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            newScript.textContent = oldScript.textContent;
                            // å¤åˆ¶æ‰€æœ‰å±æ€§
                            Array.from(oldScript.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                        
                        chartSection.appendChild(chartDiv);
                        
                        // è°ƒè¯•ï¼šæ£€æŸ¥æ’å…¥åçš„å†…å®¹
                        console.log(`${chartKey} å›¾è¡¨æ’å…¥åï¼ŒchartDivå­å…ƒç´ æ•°é‡:`, chartDiv.children.length);
                        if (chartDiv.children.length > 0) {
                            console.log(`${chartKey} ç¬¬ä¸€ä¸ªå­å…ƒç´ :`, chartDiv.children[0].tagName, chartDiv.children[0].id);
                        }
                        
                        chartsContainer.appendChild(chartSection);
                    }
                }
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log('å›¾è¡¨å·²æ’å…¥ï¼Œå›¾è¡¨æ•°é‡:', Object.keys(result.charts).length);
                console.log('Plotlyå¯¹è±¡æ˜¯å¦å­˜åœ¨:', typeof Plotly !== 'undefined');
                
            } else {
                chartError.style.display = 'block';
                chartError.innerHTML = `<p>âŒ å›¾è¡¨ç”Ÿæˆå¤±è´¥: ${result.message}</p>`;
                if (result.message.includes('Plotly')) {
                    chartError.innerHTML += '<p class="info-text">ğŸ’¡ æç¤ºï¼šéœ€è¦å®‰è£…Plotlyåº“ï¼Œè¯·è¿è¡Œ: pip install plotly</p>';
                }
            }
        } catch (error) {
            chartError.style.display = 'block';
            chartError.innerHTML = `<p>âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
        }
    });
});
</script>
{% endblock %}
