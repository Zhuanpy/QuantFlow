{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>æ•°æ®ç»Ÿè®¡è¡¨å•</h1>
        <div class="header-actions">
            <button id="refreshBtn" class="btn btn-secondary">åˆ·æ–°æ•°æ®</button>
            <a href="{{ url_for('RnnData.rnn_data_page') }}" class="btn btn-outline">è¿”å›æ•°æ®ç®¡ç†</a>
            <a href="{{ url_for('main_bp.index') }}" class="btn btn-outline">è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <!-- å¹´ä»½é€‰æ‹© -->
    <div class="year-selector">
        <div class="form-group">
            <label for="yearSelect">é€‰æ‹©å¹´ä»½</label>
            <select id="yearSelect" class="form-control">
                <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                <option value="2025">2025å¹´</option>
                <option value="2024">2024å¹´</option>
                <option value="2023">2023å¹´</option>
                <option value="2022">2022å¹´</option>
                <option value="2021">2021å¹´</option>
                <option value="2020">2020å¹´</option>
            </select>
        </div>
    </div>

    <!-- æ€»ä½“ç»Ÿè®¡ -->
    <div class="overview-stats" id="overviewStats" style="display: none;">
        <h2>æ€»ä½“ç»Ÿè®¡</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3>æ€»å­£åº¦æ•°</h3>
                    <div class="stat-number" id="totalQuarters">4</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <h3>å®Œæˆå­£åº¦</h3>
                    <div class="stat-number" id="completedQuarters">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <h3>éƒ¨åˆ†å®Œæˆ</h3>
                    <div class="stat-number" id="partialQuarters">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âŒ</div>
                <div class="stat-content">
                    <h3>æœªå¼€å§‹</h3>
                    <div class="stat-number" id="incompleteQuarters">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å­£åº¦è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼ -->
    <div class="quarter-table-panel" id="quarterTablePanel" style="display: none;">
        <div class="panel-header">
            <h2>å­£åº¦æ•°æ®è¯¦ç»†ç»Ÿè®¡</h2>
            <div class="panel-actions">
                <button id="exportBtn" class="btn btn-success">å¯¼å‡ºç»Ÿè®¡</button>
                <button id="refreshTableBtn" class="btn btn-secondary">åˆ·æ–°è¡¨æ ¼</button>
            </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="quarterTable">
                <thead>
                    <tr>
                        <th>å­£åº¦</th>
                        <th>åŸå§‹æ•°æ®çŠ¶æ€</th>
                        <th>15åˆ†é’Ÿæ•°æ®çŠ¶æ€</th>
                        <th>è®­ç»ƒæ•°æ®çŠ¶æ€</th>
                        <th>å®Œæˆåº¦</th>
                        <th>æ–‡ä»¶æ•°é‡</th>
                        <th>æ•°æ®å¤§å°</th>
                        <th>æœ€åæ›´æ–°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="quarterTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- å­£åº¦å¡ç‰‡è§†å›¾ -->
    <div class="quarter-cards" id="quarterCards" style="display: none;">
        <h2>å­£åº¦æ•°æ®çŠ¶æ€å¡ç‰‡</h2>
        <div class="cards-grid" id="cardsGrid">
            <!-- å­£åº¦å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- è§†å›¾åˆ‡æ¢ -->
    <div class="view-controls">
        <div class="view-toggle">
            <button id="tableViewBtn" class="btn btn-primary active">è¡¨æ ¼è§†å›¾</button>
            <button id="cardViewBtn" class="btn btn-outline">å¡ç‰‡è§†å›¾</button>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.header h1 {
    color: var(--text-primary);
    margin: 0;
    font-size: 2rem;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.year-selector {
    background: var(--card-background);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.form-group {
    display: flex;
    flex-direction: column;
    max-width: 300px;
}

.form-group label {
    margin-bottom: 8px;
    color: var(--text-primary);
    font-weight: 500;
}

.form-control {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.overview-stats {
    margin-bottom: 30px;
}

.overview-stats h2 {
    color: var(--text-primary);
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: var(--card-background);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-content h3 {
    margin: 0 0 8px 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.quarter-table-panel {
    background: var(--card-background);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.panel-header h2 {
    margin: 0;
    color: var(--text-primary);
}

.panel-actions {
    display: flex;
    gap: 10px;
}

.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table th,
.data-table td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--background-color);
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
}

.data-table td {
    color: var(--text-secondary);
}

.data-table tbody tr:hover {
    background: var(--background-color);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.status-success {
    background: var(--success-light);
    color: var(--success-dark);
}

.status-warning {
    background: var(--warning-light);
    color: var(--warning-dark);
}

.status-danger {
    background: var(--danger-light);
    color: var(--danger-dark);
}

.status-info {
    background: var(--info-light);
    color: var(--info-dark);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    transition: width 0.3s ease;
}

.quarter-cards {
    margin-bottom: 30px;
}

.quarter-cards h2 {
    color: var(--text-primary);
    margin-bottom: 20px;
}

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.quarter-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-left: 4px solid var(--border-color);
}

.quarter-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.quarter-card.success {
    border-left-color: var(--success-color);
}

.quarter-card.warning {
    border-left-color: var(--warning-color);
}

.quarter-card.danger {
    border-left-color: var(--danger-color);
}

.quarter-card.info {
    border-left-color: var(--info-color);
}

.quarter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.quarter-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.quarter-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.quarter-details {
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.detail-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 600;
}

.quarter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.view-controls {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

.view-toggle {
    display: flex;
    background: var(--background-color);
    border-radius: 8px;
    padding: 4px;
}

.view-toggle .btn {
    margin: 0;
    border-radius: 6px;
}

.view-toggle .btn.active {
    background: var(--primary-color);
    color: white;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: var(--success-dark);
}

.btn-secondary {
    background: var(--secondary-color);
    color: white;
}

.btn-secondary:hover {
    background: var(--secondary-dark);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .panel-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .cards-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// å…¨å±€å˜é‡
let currentYear = null;
let currentView = 'table';

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤å¹´ä»½ä¸ºå½“å‰å¹´ä»½
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.value = new Date().getFullYear();
    
    initializePage();
    bindEvents();
});

// åˆå§‹åŒ–é¡µé¢
function initializePage() {
    console.log('æ•°æ®ç»Ÿè®¡é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// ç»‘å®šäº‹ä»¶
function bindEvents() {
    // å¹´ä»½é€‰æ‹©
    document.getElementById('yearSelect').addEventListener('change', function() {
        currentYear = this.value;
        if (currentYear) {
            loadQuarterStats(currentYear);
        } else {
            hideAllPanels();
        }
    });
    
    // åˆ·æ–°æŒ‰é’®
    document.getElementById('refreshBtn').addEventListener('click', function() {
        if (currentYear) {
            loadQuarterStats(currentYear);
        }
    });
    
    // è§†å›¾åˆ‡æ¢
    document.getElementById('tableViewBtn').addEventListener('click', function() {
        switchView('table');
    });
    
    document.getElementById('cardViewBtn').addEventListener('click', function() {
        switchView('card');
    });
    
    // åˆ·æ–°è¡¨æ ¼
    document.getElementById('refreshTableBtn').addEventListener('click', function() {
        if (currentYear) {
            loadQuarterStats(currentYear);
        }
    });
    
    // å¯¼å‡ºç»Ÿè®¡
    document.getElementById('exportBtn').addEventListener('click', function() {
        exportStatistics();
    });
}

// åŠ è½½å­£åº¦ç»Ÿè®¡
async function loadQuarterStats(year) {
    try {
        const response = await fetch(`/RnnData/quarter_stats/${year}`);
        const data = await response.json();
        
        if (data.success) {
            displayOverviewStats(data.quarter_stats);
            displayQuarterTable(data.quarter_stats);
            displayQuarterCards(data.quarter_stats);
            showAllPanels();
        } else {
            alert('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥:', error);
        alert('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
function displayOverviewStats(quarterStats) {
    const stats = Object.values(quarterStats);
    
    let completed = 0;
    let partial = 0;
    let incomplete = 0;
    
    stats.forEach(stat => {
        if (stat.completion_rate === 100) {
            completed++;
        } else if (stat.completion_rate >= 50) {
            partial++;
        } else {
            incomplete++;
        }
    });
    
    document.getElementById('completedQuarters').textContent = completed;
    document.getElementById('partialQuarters').textContent = partial;
    document.getElementById('incompleteQuarters').textContent = incomplete;
}

// æ˜¾ç¤ºå­£åº¦è¡¨æ ¼
function displayQuarterTable(quarterStats) {
    const tbody = document.getElementById('quarterTableBody');
    tbody.innerHTML = '';
    
    Object.values(quarterStats).forEach(stat => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${stat.year}Q${stat.quarter}</strong></td>
            <td><span class="status-badge status-${stat.has_raw_data ? 'success' : 'danger'}">${stat.raw_status}</span></td>
            <td><span class="status-badge status-${stat.has_15m_data ? 'success' : 'danger'}">${stat.data_15m_status}</span></td>
            <td><span class="status-badge status-${stat.has_training_data ? 'success' : 'danger'}">${stat.training_status}</span></td>
            <td>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${stat.completion_rate}%"></div>
                </div>
                <span style="font-size: 12px; color: var(--text-secondary);">${stat.completion_rate}%</span>
            </td>
            <td>
                <div style="font-size: 12px;">
                    <div>åŸå§‹: ${stat.raw_data_files}</div>
                    <div>15åˆ†é’Ÿ: ${stat.data_15m_files}</div>
                    <div>è®­ç»ƒ: ${stat.training_files}</div>
                </div>
            </td>
            <td>
                <div style="font-size: 12px;">
                    <div>åŸå§‹: ${stat.raw_data_size_mb}MB</div>
                    <div>è®­ç»ƒ: ${stat.training_data_size_mb}MB</div>
                </div>
            </td>
            <td>
                <div style="font-size: 12px;">
                    <div>åŸå§‹: ${stat.last_raw_update || 'æ— '}</div>
                    <div>è®­ç»ƒ: ${stat.last_training_update || 'æ— '}</div>
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="processQuarter(${stat.year}, ${stat.quarter})">å¤„ç†</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// æ˜¾ç¤ºå­£åº¦å¡ç‰‡
function displayQuarterCards(quarterStats) {
    const grid = document.getElementById('cardsGrid');
    grid.innerHTML = '';
    
    Object.values(quarterStats).forEach(stat => {
        const card = document.createElement('div');
        card.className = `quarter-card ${stat.status_color}`;
        
        card.innerHTML = `
            <div class="quarter-header">
                <h3 class="quarter-title">${stat.year}Q${stat.quarter}</h3>
                <span class="quarter-status status-${stat.status_color}">${getStatusText(stat.completion_rate)}</span>
            </div>
            <div class="quarter-details">
                <div class="detail-row">
                    <span class="detail-label">åŸå§‹æ•°æ®:</span>
                    <span class="detail-value">${stat.raw_status} (${stat.raw_data_files}ä¸ªæ–‡ä»¶)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">15åˆ†é’Ÿæ•°æ®:</span>
                    <span class="detail-value">${stat.data_15m_status} (${stat.data_15m_files}ä¸ªæ–‡ä»¶)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">è®­ç»ƒæ•°æ®:</span>
                    <span class="detail-value">${stat.training_status} (${stat.training_files}ä¸ªæ–‡ä»¶)</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">å®Œæˆåº¦:</span>
                    <span class="detail-value">${stat.completion_rate}%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">æ•°æ®å¤§å°:</span>
                    <span class="detail-value">${stat.raw_data_size_mb}MB / ${stat.training_data_size_mb}MB</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">æœ€åæ›´æ–°:</span>
                    <span class="detail-value">${stat.last_training_update || stat.last_raw_update || 'æ— '}</span>
                </div>
            </div>
            <div class="quarter-actions">
                <button class="btn btn-sm btn-primary" onclick="processQuarter(${stat.year}, ${stat.quarter})">å¤„ç†æ­¤å­£åº¦</button>
                <button class="btn btn-sm btn-outline" onclick="viewQuarterDetails(${stat.year}, ${stat.quarter})">æŸ¥çœ‹è¯¦æƒ…</button>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(completionRate) {
    if (completionRate === 100) return 'å·²å®Œæˆ';
    if (completionRate >= 50) return 'éƒ¨åˆ†å®Œæˆ';
    return 'æœªå¼€å§‹';
}

// åˆ‡æ¢è§†å›¾
function switchView(view) {
    currentView = view;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
    document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');
    
    // æ˜¾ç¤º/éšè—å¯¹åº”é¢æ¿
    document.getElementById('quarterTablePanel').style.display = view === 'table' ? 'block' : 'none';
    document.getElementById('quarterCards').style.display = view === 'card' ? 'block' : 'none';
}

// æ˜¾ç¤ºæ‰€æœ‰é¢æ¿
function showAllPanels() {
    document.getElementById('overviewStats').style.display = 'block';
    document.getElementById('quarterTablePanel').style.display = currentView === 'table' ? 'block' : 'none';
    document.getElementById('quarterCards').style.display = currentView === 'card' ? 'block' : 'none';
}

// éšè—æ‰€æœ‰é¢æ¿
function hideAllPanels() {
    document.getElementById('overviewStats').style.display = 'none';
    document.getElementById('quarterTablePanel').style.display = 'none';
    document.getElementById('quarterCards').style.display = 'none';
}

// å¤„ç†å­£åº¦æ•°æ®
function processQuarter(year, quarter) {
    if (confirm(`ç¡®å®šè¦å¤„ç† ${year}å¹´Q${quarter} å­£åº¦çš„æ•°æ®å—ï¼Ÿ`)) {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨å¤„ç†API
        alert(`å¼€å§‹å¤„ç† ${year}å¹´Q${quarter} å­£åº¦æ•°æ®...`);
    }
}

// æŸ¥çœ‹å­£åº¦è¯¦æƒ…
function viewQuarterDetails(year, quarter) {
    alert(`æŸ¥çœ‹ ${year}å¹´Q${quarter} å­£åº¦è¯¦ç»†ä¿¡æ¯...`);
}

// å¯¼å‡ºç»Ÿè®¡
function exportStatistics() {
    if (!currentYear) {
        alert('è¯·å…ˆé€‰æ‹©å¹´ä»½');
        return;
    }
    
    // è¿™é‡Œå¯ä»¥å®ç°å¯¼å‡ºåŠŸèƒ½
    alert(`å¯¼å‡º ${currentYear} å¹´æ•°æ®ç»Ÿè®¡...`);
}
</script>
{% endblock %}



