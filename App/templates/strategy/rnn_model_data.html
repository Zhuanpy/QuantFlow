{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>RNNæ¨¡å‹æ•°æ®ç®¡ç†</h1>
        <div class="header-actions">
            <button id="refreshBtn" class="btn btn-secondary">åˆ·æ–°æ•°æ®</button>
            <a href="{{ url_for('RnnData.data_statistics_page') }}" class="btn btn-info">æ•°æ®ç»Ÿè®¡</a>
        <a href="{{ url_for('stock_pool.stock_pool_page') }}" class="btn btn-warning">è‚¡ç¥¨æ± ç®¡ç†</a>
            <a href="{{ url_for('main_bp.index') }}" class="btn btn-outline">è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <h3>è®­ç»ƒè®°å½•æ€»æ•°</h3>
                <div class="stat-number" id="totalRecords">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <h3>å¤„ç†æˆåŠŸ</h3>
                <div class="stat-number" id="successRecords">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â³</div>
            <div class="stat-content">
                <h3>å¾…å¤„ç†</h3>
                <div class="stat-number" id="pendingRecords">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âŒ</div>
            <div class="stat-content">
                <h3>å¤„ç†å¤±è´¥</h3>
                <div class="stat-number" id="failedRecords">-</div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œé¢æ¿ -->
    <div class="operation-panel">
        <div class="panel-header">
            <h2>æ•°æ®å¤„ç†æ“ä½œ</h2>
        </div>
        <div class="panel-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="yearSelect">é€‰æ‹©å¹´ä»½</label>
                    <select id="yearSelect" class="form-control">
                        <option value="">è¯·é€‰æ‹©å¹´ä»½</option>
                        <option value="2025">2025å¹´</option>
                        <option value="2024">2024å¹´</option>
                        <option value="2023">2023å¹´</option>
                        <option value="2022">2022å¹´</option>
                        <option value="2021">2021å¹´</option>
                        <option value="2020">2020å¹´</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quarterSelect">é€‰æ‹©å­£åº¦ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="quarterSelect" class="form-control">
                        <option value="">è¯·é€‰æ‹©å­£åº¦</option>
                        <option value="1">ç¬¬ä¸€å­£åº¦ (Q1)</option>
                        <option value="2">ç¬¬äºŒå­£åº¦ (Q2)</option>
                        <option value="3">ç¬¬ä¸‰å­£åº¦ (Q3)</option>
                        <option value="4">ç¬¬å››å­£åº¦ (Q4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="stockCodeInput">è‚¡ç¥¨ä»£ç ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="stockCodeInput" class="form-control" placeholder="ä¾‹å¦‚: 000001,000002">
                </div>
            </div>
            <div class="button-group">
                <button id="initYearBtn" class="btn btn-primary">åˆå§‹åŒ–å¹´ä»½æ•°æ®</button>
                <button id="processOriginalBtn" class="btn btn-success">å¤„ç†åŸå§‹15åˆ†é’Ÿæ•°æ®</button>
                <button id="processStandardBtn" class="btn btn-info">å¤„ç†æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®</button>
                <button id="processQuarterBtn" class="btn btn-primary">å¤„ç†å­£åº¦æ•°æ®</button>
                <button id="processYearBtn" class="btn btn-success">å¤„ç†æ•´å¹´æ•°æ®</button>
                <button id="processStockPoolBtn" class="btn btn-primary">åŸºäºè‚¡ç¥¨æ± å¤„ç†</button>
                <button id="checkModelBtn" class="btn btn-warning">æ£€æŸ¥æ¨¡å‹çŠ¶æ€</button>
            </div>
        </div>
    </div>

    <!-- è¿›åº¦æ˜¾ç¤º -->
    <div class="progress-panel" id="progressPanel" style="display: none;">
        <div class="progress-header">
            <h3>å¤„ç†è¿›åº¦</h3>
            <button id="cancelBtn" class="btn btn-danger btn-sm">å–æ¶ˆå¤„ç†</button>
        </div>
        <div class="progress-content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="progressText">å‡†å¤‡ä¸­...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-details">
                <div class="detail-item">
                    <span>æ€»æ•°é‡:</span>
                    <span id="totalCount">0</span>
                </div>
                <div class="detail-item">
                    <span>å·²å®Œæˆ:</span>
                    <span id="completedCount">0</span>
                </div>
                <div class="detail-item">
                    <span>æˆåŠŸ:</span>
                    <span id="successCount">0</span>
                </div>
                <div class="detail-item">
                    <span>å¤±è´¥:</span>
                    <span id="failedCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å­£åº¦ç»Ÿè®¡é¢æ¿ -->
    <div class="quarter-stats-panel" id="quarterStatsPanel" style="display: none;">
        <div class="panel-header">
            <h2>å­£åº¦æ•°æ®ç»Ÿè®¡</h2>
            <button id="refreshQuarterStatsBtn" class="btn btn-sm btn-secondary">åˆ·æ–°</button>
        </div>
        <div class="quarter-stats-content" id="quarterStatsContent">
            <!-- å­£åº¦ç»Ÿè®¡å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="data-table-panel">
        <div class="table-header">
            <h2>è®­ç»ƒè®°å½•è¯¦æƒ…</h2>
            <div class="table-controls">
                <input type="text" id="searchInput" placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§°..." class="form-control">
                <select id="statusFilter" class="form-control">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending">å¾…å¤„ç†</option>
                    <option value="processing">å¤„ç†ä¸­</option>
                    <option value="success">æˆåŠŸ</option>
                    <option value="failed">å¤±è´¥</option>
                </select>
                <button id="showQuarterStatsBtn" class="btn btn-sm btn-info">æ˜¾ç¤ºå­£åº¦ç»Ÿè®¡</button>
            </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="recordsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>è‚¡ç¥¨åç§°</th>
                        <th>è§£ææœˆä»½</th>
                        <th>åŸå§‹æ•°æ®çŠ¶æ€</th>
                        <th>æ ‡å‡†åŒ–æ•°æ®çŠ¶æ€</th>
                        <th>æ¨¡å‹æ£€æŸ¥çŠ¶æ€</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>
        <div class="table-pagination">
            <button id="prevPageBtn" class="btn btn-outline">ä¸Šä¸€é¡µ</button>
            <span id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
            <button id="nextPageBtn" class="btn btn-outline">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.header h1 {
    color: var(--text-primary);
    margin: 0;
    font-size: 2rem;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-background);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-content h3 {
    margin: 0 0 8px 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.operation-panel {
    background: var(--card-background);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.panel-header h2 {
    margin: 0 0 20px 0;
    color: var(--text-primary);
    font-size: 1.3rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    color: var(--text-primary);
    font-weight: 500;
}

.form-control {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: var(--success-dark);
}

.btn-info {
    background: var(--info-color);
    color: white;
}

.btn-info:hover {
    background: var(--info-dark);
}

.btn-warning {
    background: var(--warning-color);
    color: white;
}

.btn-warning:hover {
    background: var(--warning-dark);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: var(--danger-dark);
}

.btn-secondary {
    background: var(--secondary-color);
    color: white;
}

.btn-secondary:hover {
    background: var(--secondary-dark);
}

.btn-outline {
    background: transparent;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.progress-panel {
    background: var(--card-background);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.progress-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 15px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-weight: 500;
}

.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--background-color);
    border-radius: 6px;
    font-size: 0.9rem;
}

.data-table-panel {
    background: var(--card-background);
    border-radius: 12px;
    padding: 25px;
    box-shadow: var(--shadow-sm);
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.table-header h2 {
    margin: 0;
    color: var(--text-primary);
}

.table-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.table-container {
    overflow-x: auto;
    margin-bottom: 20px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table th,
.data-table td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--background-color);
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
}

.data-table td {
    color: var(--text-secondary);
}

.data-table tbody tr:hover {
    background: var(--background-color);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.status-pending {
    background: var(--warning-light);
    color: var(--warning-dark);
}

.status-processing {
    background: var(--info-light);
    color: var(--info-dark);
}

.status-success {
    background: var(--success-light);
    color: var(--success-dark);
}

.status-failed {
    background: var(--danger-light);
    color: var(--danger-dark);
}

.table-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
}

#pageInfo {
    color: var(--text-secondary);
    font-size: 14px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    .header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .table-controls {
        flex-direction: column;
    }
}

/* å­£åº¦ç»Ÿè®¡é¢æ¿æ ·å¼ */
.quarter-stats-panel {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 20px;
}

.quarter-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.quarter-stat-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    background: white;
    transition: all 0.3s ease;
}

.quarter-stat-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.quarter-stat-card.success {
    border-left: 4px solid #28a745;
}

.quarter-stat-card.warning {
    border-left: 4px solid #ffc107;
}

.quarter-stat-card.danger {
    border-left: 4px solid #dc3545;
}

.quarter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.quarter-header h3 {
    margin: 0;
    color: #333;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-badge.success {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.warning {
    background-color: #fff3cd;
    color: #856404;
}

.status-badge.danger {
    background-color: #f8d7da;
    color: #721c24;
}

.quarter-details {
    margin-bottom: 15px;
}

.quarter-details .detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 14px;
}

.quarter-actions {
    text-align: right;
}
</style>

<script>
// å…¨å±€å˜é‡
let currentPage = 1;
let pageSize = 20;
let totalPages = 1;
let isProcessing = false;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤å¹´ä»½ä¸ºå½“å‰å¹´ä»½
    const currentYear = new Date().getFullYear();
    const yearSelect = document.getElementById('yearSelect');
    yearSelect.value = currentYear;
    
    initializePage();
    bindEvents();
    loadStatistics();
    loadRecords();
});

// åˆå§‹åŒ–é¡µé¢
function initializePage() {
    console.log('RNNæ¨¡å‹æ•°æ®ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// ç»‘å®šäº‹ä»¶
function bindEvents() {
    // åˆ·æ–°æŒ‰é’®
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadStatistics();
        loadRecords();
    });
    
    // åˆå§‹åŒ–å¹´ä»½æ•°æ®
    document.getElementById('initYearBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        if (!year) {
            alert('è¯·é€‰æ‹©å¹´ä»½');
            return;
        }
        initYearData(year);
    });
    
    // å¤„ç†åŸå§‹15åˆ†é’Ÿæ•°æ®
    document.getElementById('processOriginalBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        if (!year) {
            alert('è¯·é€‰æ‹©å¹´ä»½');
            return;
        }
        processOriginalData(year);
    });
    
    // å¤„ç†æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®
    document.getElementById('processStandardBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        if (!year) {
            alert('è¯·é€‰æ‹©å¹´ä»½');
            return;
        }
        processStandardData(year);
    });
    
    // å¤„ç†å­£åº¦æ•°æ®
    document.getElementById('processQuarterBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        const quarter = document.getElementById('quarterSelect').value;
        
        if (!year) {
            alert('è¯·é€‰æ‹©å¹´ä»½');
            return;
        }
        
        if (!quarter) {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©å­£åº¦ï¼Œå¼¹å‡ºé€‰æ‹©æ¡†
            const quarterInput = prompt('è¯·è¾“å…¥å­£åº¦ (1-4):');
            if (!quarterInput || !['1', '2', '3', '4'].includes(quarterInput)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å­£åº¦ (1-4)');
                return;
            }
            processQuarterData(parseInt(year), parseInt(quarterInput));
        } else {
            processQuarterData(parseInt(year), parseInt(quarter));
        }
    });
    
    // å¤„ç†æ•´å¹´æ•°æ®
    document.getElementById('processYearBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        const quarter = document.getElementById('quarterSelect').value;
        
        if (!year) {
            alert('è¯·é€‰æ‹©å¹´ä»½');
            return;
        }
        
        if (quarter) {
            // å¦‚æœé€‰æ‹©äº†ç‰¹å®šå­£åº¦ï¼Œåªå¤„ç†è¯¥å­£åº¦
            if (!confirm(`ç¡®å®šè¦å¤„ç† ${year} å¹´ç¬¬${quarter}å­£åº¦çš„æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            processQuarterData(parseInt(year), parseInt(quarter));
        } else {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©å­£åº¦ï¼Œå¤„ç†æ‰€æœ‰å­£åº¦
            if (!confirm(`ç¡®å®šè¦å¤„ç† ${year} å¹´æ‰€æœ‰å­£åº¦çš„æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            processYearData(parseInt(year));
        }
    });
    
    // æ£€æŸ¥æ¨¡å‹çŠ¶æ€
    document.getElementById('checkModelBtn').addEventListener('click', function() {
        checkModelStatus();
    });
    
    // åŸºäºè‚¡ç¥¨æ± å¤„ç†
    document.getElementById('processStockPoolBtn').addEventListener('click', function() {
        showStockPoolProcessModal();
    });
    
    // å–æ¶ˆå¤„ç†
    document.getElementById('cancelBtn').addEventListener('click', function() {
        cancelProcessing();
    });
    
    // æœç´¢åŠŸèƒ½
    document.getElementById('searchInput').addEventListener('input', function() {
        loadRecords();
    });
    
    // çŠ¶æ€ç­›é€‰
    document.getElementById('statusFilter').addEventListener('change', function() {
        loadRecords();
    });
    
    // åˆ†é¡µæŒ‰é’®
    document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadRecords();
        }
    });
    
    document.getElementById('nextPageBtn').addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            loadRecords();
        }
    });
    
    // æ˜¾ç¤ºå­£åº¦ç»Ÿè®¡
    document.getElementById('showQuarterStatsBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        if (!year) {
            alert('è¯·å…ˆé€‰æ‹©å¹´ä»½');
            return;
        }
        loadQuarterStats(parseInt(year));
    });
    
    // åˆ·æ–°å­£åº¦ç»Ÿè®¡
    document.getElementById('refreshQuarterStatsBtn').addEventListener('click', function() {
        const year = document.getElementById('yearSelect').value;
        if (year) {
            loadQuarterStats(parseInt(year));
        }
    });
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
    try {
        const response = await fetch('/RnnData/statistics');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalRecords').textContent = data.total || 0;
            document.getElementById('successRecords').textContent = data.success || 0;
            document.getElementById('pendingRecords').textContent = data.pending || 0;
            document.getElementById('failedRecords').textContent = data.failed || 0;
        }
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// åŠ è½½è®°å½•åˆ—è¡¨
async function loadRecords() {
    try {
        const searchTerm = document.getElementById('searchInput').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        const params = new URLSearchParams({
            page: currentPage,
            page_size: pageSize,
            search: searchTerm,
            status: statusFilter
        });
        
        const response = await fetch(`/RnnData/records?${params}`);
        const data = await response.json();
        
        if (data.success) {
            renderRecordsTable(data.records);
            updatePagination(data.pagination);
        }
    } catch (error) {
        console.error('åŠ è½½è®°å½•åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ¸²æŸ“è®°å½•è¡¨æ ¼
function renderRecordsTable(records) {
    const tbody = document.getElementById('recordsTableBody');
    tbody.innerHTML = '';
    
    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.code || '-'}</td>
            <td>${record.name || '-'}</td>
            <td>${record.parser_month || '-'}</td>
            <td><span class="status-badge status-${record.original_15M?.status || 'pending'}">${record.original_15M?.status || 'pending'}</span></td>
            <td><span class="status-badge status-${record.standard_15M?.status || 'pending'}">${record.standard_15M?.status || 'pending'}</span></td>
            <td><span class="status-badge status-${record.model_check || 'pending'}">${record.model_check || 'pending'}</span></td>
            <td>${record.created_at ? new Date(record.created_at).toLocaleString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="viewRecord(${record.id})">æŸ¥çœ‹</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// æ›´æ–°åˆ†é¡µä¿¡æ¯
function updatePagination(pagination) {
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
    document.getElementById('prevPageBtn').disabled = currentPage <= 1;
    document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
}

// åˆå§‹åŒ–å¹´ä»½æ•°æ®
async function initYearData(year) {
    if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦åˆå§‹åŒ– ${year} å¹´çš„æ•°æ®å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰ç›¸å…³è®°å½•çš„çŠ¶æ€ã€‚`)) {
        return;
    }
    
    try {
        isProcessing = true;
        showProgress('æ­£åœ¨åˆå§‹åŒ–å¹´ä»½æ•°æ®...');
        
        const response = await fetch(`/RnnData/init_year/${year}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('å¹´ä»½æ•°æ®åˆå§‹åŒ–æˆåŠŸï¼');
            loadStatistics();
            loadRecords();
        } else {
            alert('åˆå§‹åŒ–å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–å¹´ä»½æ•°æ®å¤±è´¥:', error);
        alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    } finally {
        isProcessing = false;
        hideProgress();
    }
}

// å¤„ç†åŸå§‹15åˆ†é’Ÿæ•°æ®
async function processOriginalData(year) {
    if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
    }
    
    try {
        isProcessing = true;
        showProgress('æ­£åœ¨å¤„ç†åŸå§‹15åˆ†é’Ÿæ•°æ®...');
        
        const response = await fetch(`/RnnData/original_15M/${year}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('åŸå§‹15åˆ†é’Ÿæ•°æ®å¤„ç†å®Œæˆï¼');
            loadStatistics();
            loadRecords();
        } else {
            alert('å¤„ç†å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('å¤„ç†åŸå§‹15åˆ†é’Ÿæ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
    } finally {
        isProcessing = false;
        hideProgress();
    }
}

// å¤„ç†æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®
async function processStandardData(year) {
    if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
    }
    
    try {
        isProcessing = true;
        showProgress('æ­£åœ¨å¤„ç†æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®...');
        
        const response = await fetch(`/RnnData/standard_15M/${year}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®å¤„ç†å®Œæˆï¼');
            loadStatistics();
            loadRecords();
        } else {
            alert('å¤„ç†å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('å¤„ç†æ ‡å‡†åŒ–15åˆ†é’Ÿæ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
    } finally {
        isProcessing = false;
        hideProgress();
    }
}

// æ£€æŸ¥æ¨¡å‹çŠ¶æ€
async function checkModelStatus() {
    try {
        const response = await fetch('/RnnData/check_models', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('æ¨¡å‹çŠ¶æ€æ£€æŸ¥å®Œæˆï¼');
            loadStatistics();
            loadRecords();
        } else {
            alert('æ£€æŸ¥å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('æ£€æŸ¥æ¨¡å‹çŠ¶æ€å¤±è´¥:', error);
        alert('æ£€æŸ¥å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºè‚¡ç¥¨æ± å¤„ç†æ¨¡æ€æ¡†
function showStockPoolProcessModal() {
    // åˆ›å»ºæ¨¡æ€æ¡†HTML
    const modalHtml = `
        <div class="modal fade" id="stockPoolProcessModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">åŸºäºè‚¡ç¥¨æ± å¤„ç†RNNæ•°æ®</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stockPoolType">è‚¡ç¥¨æ± ç±»å‹</label>
                                    <select class="form-control" id="stockPoolType">
                                        <option value="training">è®­ç»ƒæ± </option>
                                        <option value="testing">æµ‹è¯•æ± </option>
                                        <option value="validation">éªŒè¯æ± </option>
                                        <option value="general">é€šç”¨æ± </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stockPoolYear">å¹´ä»½</label>
                                    <select class="form-control" id="stockPoolYear">
                                        <option value="2025">2025å¹´</option>
                                        <option value="2024">2024å¹´</option>
                                        <option value="2023">2023å¹´</option>
                                        <option value="2022">2022å¹´</option>
                                        <option value="2021">2021å¹´</option>
                                        <option value="2020">2020å¹´</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="stockPoolQuarter">å­£åº¦ï¼ˆå¯é€‰ï¼‰</label>
                                    <select class="form-control" id="stockPoolQuarter">
                                        <option value="">å…¨éƒ¨å­£åº¦</option>
                                        <option value="1">ç¬¬ä¸€å­£åº¦</option>
                                        <option value="2">ç¬¬äºŒå­£åº¦</option>
                                        <option value="3">ç¬¬ä¸‰å­£åº¦</option>
                                        <option value="4">ç¬¬å››å­£åº¦</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>è‚¡ç¥¨æ± ç»Ÿè®¡</label>
                                    <div id="stockPoolStats" class="alert alert-info">
                                        æ­£åœ¨åŠ è½½è‚¡ç¥¨æ± ç»Ÿè®¡ä¿¡æ¯...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="processStockPoolData()">å¼€å§‹å¤„ç†</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('stockPoolProcessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('#stockPoolProcessModal').modal('show');
    
    // åŠ è½½è‚¡ç¥¨æ± ç»Ÿè®¡ä¿¡æ¯
    loadStockPoolStats();
}

// åŠ è½½è‚¡ç¥¨æ± ç»Ÿè®¡ä¿¡æ¯
async function loadStockPoolStats() {
    try {
        const response = await fetch('/RnnData/api/stock_pool_stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            const statsHtml = `
                <div class="row">
                    <div class="col-6">
                        <small>æ€»è‚¡ç¥¨æ•°: <strong>${stats.total_stocks}</strong></small><br>
                        <small>æ¿€æ´»è‚¡ç¥¨: <strong>${stats.active_stocks}</strong></small>
                    </div>
                    <div class="col-6">
                        <small>è®­ç»ƒå°±ç»ª: <strong>${stats.training_ready}</strong></small><br>
                        <small>ç±»å‹åˆ†å¸ƒ: ${JSON.stringify(stats.type_distribution)}</small>
                    </div>
                </div>
            `;
            document.getElementById('stockPoolStats').innerHTML = statsHtml;
        } else {
            document.getElementById('stockPoolStats').innerHTML = 
                '<div class="alert alert-warning">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + data.message + '</div>';
        }
    } catch (error) {
        console.error('åŠ è½½è‚¡ç¥¨æ± ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('stockPoolStats').innerHTML = 
            '<div class="alert alert-danger">åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + error.message + '</div>';
    }
}

// å¤„ç†è‚¡ç¥¨æ± æ•°æ®
async function processStockPoolData() {
    const poolType = document.getElementById('stockPoolType').value;
    const year = document.getElementById('stockPoolYear').value;
    const quarter = document.getElementById('stockPoolQuarter').value;
    
    if (!year) {
        alert('è¯·é€‰æ‹©å¹´ä»½');
        return;
    }
    
    try {
        const data = {
            pool_type: poolType,
            year: parseInt(year),
            quarter: quarter ? parseInt(quarter) : null
        };
        
        const response = await fetch('/RnnData/api/process_stock_pool_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            $('#stockPoolProcessModal').modal('hide');
            // å¼€å§‹è½®è¯¢è¿›åº¦
            startProgressPolling();
        } else {
            alert('å¤„ç†å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        console.error('å¤„ç†è‚¡ç¥¨æ± æ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
    }
}

// å–æ¶ˆå¤„ç†
function cancelProcessing() {
    if (confirm('ç¡®å®šè¦å–æ¶ˆå½“å‰å¤„ç†å—ï¼Ÿ')) {
        isProcessing = false;
        hideProgress();
        alert('å¤„ç†å·²å–æ¶ˆ');
    }
}

// æ˜¾ç¤ºè¿›åº¦é¢æ¿
function showProgress(message) {
    const panel = document.getElementById('progressPanel');
    const text = document.getElementById('progressText');
    text.textContent = message;
    panel.style.display = 'block';
}

// éšè—è¿›åº¦é¢æ¿
function hideProgress() {
    const panel = document.getElementById('progressPanel');
    panel.style.display = 'none';
}

// å¤„ç†å­£åº¦æ•°æ®
async function processQuarterData(year, quarter) {
    if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
    }
    
    try {
        isProcessing = true;
        showProgress(`æ­£åœ¨å¤„ç† ${year}å¹´Q${quarter} å­£åº¦æ•°æ®...`);
        
        const response = await fetch(`/RnnData/process_quarter/${year}/${quarter}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stock_codes: document.getElementById('stockCodeInput').value ? 
                    document.getElementById('stockCodeInput').value.split(',').map(s => s.trim()) : null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`${year}å¹´Q${quarter}å­£åº¦æ•°æ®å¤„ç†å®Œæˆï¼`);
            loadStatistics();
            loadRecords();
        } else {
            alert('å¤„ç†å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('å¤„ç†å­£åº¦æ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
    } finally {
        isProcessing = false;
        hideProgress();
    }
}

// å¤„ç†æ•´å¹´æ•°æ®
async function processYearData(year) {
    if (isProcessing) {
        alert('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
        return;
    }
    
    try {
        isProcessing = true;
        showProgress(`æ­£åœ¨å¤„ç† ${year} å¹´æ‰€æœ‰å­£åº¦æ•°æ®...`);
        
        const response = await fetch(`/RnnData/process_quarters/${year}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quarters: [1, 2, 3, 4],
                stock_codes: document.getElementById('stockCodeInput').value ? 
                    document.getElementById('stockCodeInput').value.split(',').map(s => s.trim()) : null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`${year}å¹´å­£åº¦æ•°æ®å¤„ç†å®Œæˆï¼\n${data.message}`);
            loadStatistics();
            loadRecords();
        } else {
            alert('å¤„ç†å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('å¤„ç†æ•´å¹´æ•°æ®å¤±è´¥:', error);
        alert('å¤„ç†å¤±è´¥: ' + error.message);
    } finally {
        isProcessing = false;
        hideProgress();
    }
}

// åŠ è½½å­£åº¦ç»Ÿè®¡
async function loadQuarterStats(year) {
    try {
        const response = await fetch(`/RnnData/quarter_stats/${year}`);
        const data = await response.json();
        
        if (data.success) {
            displayQuarterStats(data.quarter_stats);
            document.getElementById('quarterStatsPanel').style.display = 'block';
        } else {
            alert('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥:', error);
        alert('åŠ è½½å­£åº¦ç»Ÿè®¡å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºå­£åº¦ç»Ÿè®¡
function displayQuarterStats(quarterStats) {
    const content = document.getElementById('quarterStatsContent');
    
    let html = '<div class="quarter-stats-grid">';
    
    for (const [quarter, stats] of Object.entries(quarterStats)) {
        const statusClass = stats.has_training_data ? 'success' : (stats.has_raw_data ? 'warning' : 'danger');
        const statusText = stats.has_training_data ? 'å·²å¤„ç†' : (stats.has_raw_data ? 'æœ‰åŸå§‹æ•°æ®' : 'æ— æ•°æ®');
        
        html += `
            <div class="quarter-stat-card ${statusClass}">
                <div class="quarter-header">
                    <h3>${quarter}</h3>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="quarter-details">
                    <div class="detail-item">
                        <span>åŸå§‹æ•°æ®æ–‡ä»¶:</span>
                        <span>${stats.raw_data_files}</span>
                    </div>
                    <div class="detail-item">
                        <span>è®­ç»ƒæ•°æ®æ–‡ä»¶:</span>
                        <span>${stats.training_files}</span>
                    </div>
                </div>
                <div class="quarter-actions">
                    <button class="btn btn-sm btn-primary" onclick="processQuarterData(${quarter.replace('Q', '')}, ${quarter.replace(/^\d+Q/, '')})">
                        å¤„ç†æ­¤å­£åº¦
                    </button>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    content.innerHTML = html;
}

// æŸ¥çœ‹è®°å½•è¯¦æƒ…
function viewRecord(recordId) {
    // è¿™é‡Œå¯ä»¥å®ç°æŸ¥çœ‹è®°å½•è¯¦æƒ…çš„åŠŸèƒ½
    alert('æŸ¥çœ‹è®°å½•è¯¦æƒ…åŠŸèƒ½å¾…å®ç°ï¼Œè®°å½•ID: ' + recordId);
}
</script>
{% endblock %}
