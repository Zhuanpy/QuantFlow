{% extends "base.html" %}

{% block title %}股票池管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-database"></i> 股票池管理
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" onclick="showCreateFromRecordsModal()">
                            <i class="fas fa-plus"></i> 从下载记录创建
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportStocks()">
                            <i class="fas fa-download"></i> 导出数据
                        </button>
                        <button type="button" class="btn btn-info" onclick="refreshData()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                    </div>
                </div>
                
                <!-- 统计面板 -->
                <div class="card-body">
                    <div class="row mb-3" id="statisticsPanel">
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="fas fa-database"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">总股票数</span>
                                    <span class="info-box-number" id="totalStocks">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">激活股票</span>
                                    <span class="info-box-number" id="activeStocks">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning"><i class="fas fa-cogs"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">训练就绪</span>
                                    <span class="info-box-number" id="trainingReady">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger"><i class="fas fa-times-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">排除股票</span>
                                    <span class="info-box-number" id="excludedStocks">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 筛选条件 -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <select class="form-control" id="poolTypeFilter">
                                <option value="">所有类型</option>
                                <option value="general">通用</option>
                                <option value="training">训练</option>
                                <option value="testing">测试</option>
                                <option value="validation">验证</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="industryFilter">
                                <option value="">所有行业</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="activeFilter">
                                <option value="true">激活</option>
                                <option value="false">已排除</option>
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="trainingReadyFilter">
                                <option value="">训练状态</option>
                                <option value="true">训练就绪</option>
                                <option value="false">未就绪</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索股票代码或名称">
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 批量操作 -->
                    <div class="row mb-3" id="batchOperations" style="display: none;">
                        <div class="col-12">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success" onclick="batchUpdate('pool_type', 'training')">
                                    设为训练池
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="batchUpdate('pool_type', 'testing')">
                                    设为测试池
                                </button>
                                <button class="btn btn-sm btn-info" onclick="batchUpdate('is_training_ready', true)">
                                    设为训练就绪
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="batchExclude()">
                                    批量排除
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 数据表格 -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="stocksTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>股票代码</th>
                                    <th>股票名称</th>
                                    <th>股票池类型</th>
                                    <th>优先级</th>
                                    <th>数据质量</th>
                                    <th>完整性</th>
                                    <th>训练就绪</th>
                                    <th>训练状态</th>
                                    <th>行业</th>
                                    <th>板块</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="stocksTableBody">
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <div class="row">
                        <div class="col-12">
                            <nav aria-label="分页导航">
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- 分页将通过JavaScript动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 从记录创建模态框 -->
<div class="modal fade" id="createFromRecordsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">从下载记录创建股票池</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createFromRecordsForm">
                    <div class="form-group">
                        <label for="poolType">股票池类型</label>
                        <select class="form-control" id="poolType" name="pool_type">
                            <option value="general">通用</option>
                            <option value="training">训练</option>
                            <option value="testing">测试</option>
                            <option value="validation">验证</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="minQualityScore">最低质量评分</label>
                        <input type="number" class="form-control" id="minQualityScore" name="min_quality_score" 
                               min="0" max="100" value="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="minCompleteness">最低完整性</label>
                        <input type="number" class="form-control" id="minCompleteness" name="min_completeness" 
                               min="0" max="100" value="0" step="0.1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createFromRecords()">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑股票模态框 -->
<div class="modal fade" id="editStockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑股票信息</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editStockForm">
                    <input type="hidden" id="editStockId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editStockCode">股票代码</label>
                                <input type="text" class="form-control" id="editStockCode" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editStockName">股票名称</label>
                                <input type="text" class="form-control" id="editStockName">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPoolType">股票池类型</label>
                                <select class="form-control" id="editPoolType">
                                    <option value="general">通用</option>
                                    <option value="training">训练</option>
                                    <option value="testing">测试</option>
                                    <option value="validation">验证</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPriority">优先级</label>
                                <input type="number" class="form-control" id="editPriority" min="1" max="5">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editQualityScore">数据质量评分</label>
                                <input type="number" class="form-control" id="editQualityScore" min="0" max="100" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editCompleteness">数据完整性</label>
                                <input type="number" class="form-control" id="editCompleteness" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editIndustry">行业</label>
                                <input type="text" class="form-control" id="editIndustry">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editBoard">板块</label>
                                <input type="text" class="form-control" id="editBoard">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editMarketCap">市值</label>
                                <input type="number" class="form-control" id="editMarketCap">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPeRatio">市盈率</label>
                                <input type="number" class="form-control" id="editPeRatio" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPbRatio">市净率</label>
                                <input type="number" class="form-control" id="editPbRatio" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editTrainingReady">训练就绪</label>
                                <select class="form-control" id="editTrainingReady">
                                    <option value="false">否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editTrainingStatus">训练状态</label>
                                <select class="form-control" id="editTrainingStatus">
                                    <option value="pending">待处理</option>
                                    <option value="processing">处理中</option>
                                    <option value="completed">已完成</option>
                                    <option value="failed">失败</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editIsActive">激活状态</label>
                                <select class="form-control" id="editIsActive">
                                    <option value="true">激活</option>
                                    <option value="false">停用</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveStockEdit()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let selectedStocks = new Set();

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadStocks();
    bindEvents();
});

// 绑定事件
function bindEvents() {
    // 搜索框回车事件
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
}

// 加载统计信息
async function loadStatistics() {
    try {
        const response = await fetch('/stock_pool/api/statistics');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalStocks').textContent = data.data.total_stocks || 0;
            document.getElementById('activeStocks').textContent = data.data.active_stocks || 0;
            document.getElementById('trainingReady').textContent = data.data.training_ready || 0;
            document.getElementById('excludedStocks').textContent = data.data.excluded_stocks || 0;
        }
    } catch (error) {
        console.error('加载统计信息失败:', error);
    }
}

// 加载股票列表
async function loadStocks(page = 1) {
    try {
        const params = new URLSearchParams({
            page: page,
            page_size: 20,
            pool_type: document.getElementById('poolTypeFilter').value,
            industry: document.getElementById('industryFilter').value,
            is_active: document.getElementById('activeFilter').value,
            is_training_ready: document.getElementById('trainingReadyFilter').value,
            search: document.getElementById('searchInput').value
        });
        
        const response = await fetch(`/stock_pool/api/stocks?${params}`);
        const data = await response.json();
        
        if (data.success) {
            displayStocks(data.data.stocks);
            displayPagination(data.data.pagination);
            currentPage = page;
        } else {
            showAlert('加载股票列表失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('加载股票列表失败:', error);
        showAlert('加载股票列表失败: ' + error.message, 'error');
    }
}

// 显示股票列表
function displayStocks(stocks) {
    const tbody = document.getElementById('stocksTableBody');
    tbody.innerHTML = '';
    
    stocks.forEach(stock => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="stock-checkbox" value="${stock.id}" 
                       onchange="toggleStockSelection(${stock.id})">
            </td>
            <td>${stock.stock_code}</td>
            <td>${stock.stock_name || '-'}</td>
            <td>
                <span class="badge badge-${getPoolTypeBadgeClass(stock.pool_type)}">
                    ${getPoolTypeText(stock.pool_type)}
                </span>
            </td>
            <td>${stock.pool_priority}</td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" style="width: ${stock.data_quality_score}%">
                        ${stock.data_quality_score.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" style="width: ${stock.data_completeness}%">
                        ${stock.data_completeness.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>
                <span class="badge badge-${stock.is_training_ready ? 'success' : 'secondary'}">
                    ${stock.is_training_ready ? '是' : '否'}
                </span>
            </td>
            <td>
                <span class="badge badge-${getTrainingStatusBadgeClass(stock.training_status)}">
                    ${getTrainingStatusText(stock.training_status)}
                </span>
            </td>
            <td>${stock.industry || '-'}</td>
            <td>${stock.board || '-'}</td>
            <td>
                <span class="badge badge-${stock.is_active && !stock.is_excluded ? 'success' : 'danger'}">
                    ${stock.is_active && !stock.is_excluded ? '激活' : '停用'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editStock(${stock.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteStock(${stock.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 显示分页
function displayPagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    paginationEl.innerHTML = '';
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${!pagination.has_prev ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadStocks(${pagination.prev_num})">上一页</a>`;
    paginationEl.appendChild(prevLi);
    
    // 页码
    for (let i = 1; i <= pagination.pages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="loadStocks(${i})">${i}</a>`;
        paginationEl.appendChild(li);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadStocks(${pagination.next_num})">下一页</a>`;
    paginationEl.appendChild(nextLi);
}

// 应用筛选条件
function applyFilters() {
    currentPage = 1;
    loadStocks(currentPage);
}

// 刷新数据
function refreshData() {
    loadStatistics();
    loadStocks(currentPage);
}

// 显示从记录创建模态框
function showCreateFromRecordsModal() {
    $('#createFromRecordsModal').modal('show');
}

// 从记录创建股票池
async function createFromRecords() {
    try {
        const formData = new FormData(document.getElementById('createFromRecordsForm'));
        const data = Object.fromEntries(formData.entries());
        
        const response = await fetch('/stock_pool/api/create_from_records', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            $('#createFromRecordsModal').modal('hide');
            refreshData();
        } else {
            showAlert('创建失败: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('创建股票池失败:', error);
        showAlert('创建失败: ' + error.message, 'error');
    }
}

// 编辑股票
async function editStock(stockId) {
    try {
        // 这里应该先获取股票详细信息
        // 为了简化，我们直接显示模态框
        $('#editStockModal').modal('show');
        document.getElementById('editStockId').value = stockId;
        
        // 实际应用中应该先获取股票数据并填充表单
    } catch (error) {
        console.error('编辑股票失败:', error);
        showAlert('编辑失败: ' + error.message, 'error');
    }
}

// 保存股票编辑
async function saveStockEdit() {
    try {
        const stockId = document.getElementById('editStockId').value;
        const data = {
            pool_type: document.getElementById('editPoolType').value,
            pool_priority: parseInt(document.getElementById('editPriority').value),
            data_quality_score: parseFloat(document.getElementById('editQualityScore').value),
            data_completeness: parseFloat(document.getElementById('editCompleteness').value),
            industry: document.getElementById('editIndustry').value,
            board: document.getElementById('editBoard').value,
            market_cap: parseInt(document.getElementById('editMarketCap').value) || null,
            pe_ratio: parseFloat(document.getElementById('editPeRatio').value) || null,
            pb_ratio: parseFloat(document.getElementById('editPbRatio').value) || null,
            is_training_ready: document.getElementById('editTrainingReady').value === 'true',
            training_status: document.getElementById('editTrainingStatus').value,
            is_active: document.getElementById('editIsActive').value === 'true'
        };
        
        const response = await fetch(`/stock_pool/api/update/${stockId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('更新成功', 'success');
            $('#editStockModal').modal('hide');
            refreshData();
        } else {
            showAlert('更新失败: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('保存编辑失败:', error);
        showAlert('保存失败: ' + error.message, 'error');
    }
}

// 删除股票
async function deleteStock(stockId) {
    if (!confirm('确定要删除这个股票吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/stock_pool/api/delete/${stockId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('删除成功', 'success');
            refreshData();
        } else {
            showAlert('删除失败: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('删除股票失败:', error);
        showAlert('删除失败: ' + error.message, 'error');
    }
}

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.stock-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedStocks.add(parseInt(checkbox.value));
        } else {
            selectedStocks.delete(parseInt(checkbox.value));
        }
    });
    
    updateBatchOperations();
}

// 切换单个股票选择
function toggleStockSelection(stockId) {
    if (selectedStocks.has(stockId)) {
        selectedStocks.delete(stockId);
    } else {
        selectedStocks.add(stockId);
    }
    
    updateBatchOperations();
}

// 更新批量操作显示
function updateBatchOperations() {
    const batchOps = document.getElementById('batchOperations');
    if (selectedStocks.size > 0) {
        batchOps.style.display = 'block';
    } else {
        batchOps.style.display = 'none';
    }
}

// 批量更新
async function batchUpdate(field, value) {
    if (selectedStocks.size === 0) {
        showAlert('请先选择要更新的股票', 'warning');
        return;
    }
    
    try {
        const data = {
            stock_ids: Array.from(selectedStocks),
            updates: { [field]: value }
        };
        
        const response = await fetch('/stock_pool/api/batch_update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            selectedStocks.clear();
            document.getElementById('selectAll').checked = false;
            updateBatchOperations();
            refreshData();
        } else {
            showAlert('批量更新失败: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('批量更新失败:', error);
        showAlert('批量更新失败: ' + error.message, 'error');
    }
}

// 批量排除
async function batchExclude() {
    if (selectedStocks.size === 0) {
        showAlert('请先选择要排除的股票', 'warning');
        return;
    }
    
    const reason = prompt('请输入排除原因:');
    if (!reason) {
        return;
    }
    
    try {
        for (const stockId of selectedStocks) {
            // 这里应该调用排除API
            // 为了简化，我们使用批量更新
            await batchUpdate('is_excluded', true);
            await batchUpdate('exclusion_reason', reason);
        }
        
        showAlert('批量排除成功', 'success');
        selectedStocks.clear();
        document.getElementById('selectAll').checked = false;
        updateBatchOperations();
        refreshData();
    } catch (error) {
        console.error('批量排除失败:', error);
        showAlert('批量排除失败: ' + error.message, 'error');
    }
}

// 导出股票数据
function exportStocks() {
    const params = new URLSearchParams({
        pool_type: document.getElementById('poolTypeFilter').value,
        industry: document.getElementById('industryFilter').value,
        is_active: document.getElementById('activeFilter').value
    });
    
    window.open(`/stock_pool/api/export?${params}`, '_blank');
}

// 工具函数
function getPoolTypeBadgeClass(type) {
    const classes = {
        'general': 'secondary',
        'training': 'primary',
        'testing': 'warning',
        'validation': 'info'
    };
    return classes[type] || 'secondary';
}

function getPoolTypeText(type) {
    const texts = {
        'general': '通用',
        'training': '训练',
        'testing': '测试',
        'validation': '验证'
    };
    return texts[type] || type;
}

function getTrainingStatusBadgeClass(status) {
    const classes = {
        'pending': 'secondary',
        'processing': 'warning',
        'completed': 'success',
        'failed': 'danger'
    };
    return classes[status] || 'secondary';
}

function getTrainingStatusText(status) {
    const texts = {
        'pending': '待处理',
        'processing': '处理中',
        'completed': '已完成',
        'failed': '失败'
    };
    return texts[status] || status;
}

function showAlert(message, type) {
    // 这里应该使用实际的提示组件
    alert(message);
}
</script>
{% endblock %}



